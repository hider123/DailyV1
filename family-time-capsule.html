<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æ™‚å…‰è† å›Š - äº’å‹•åŸå‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <!-- Image Compression Library -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <!-- EXIF Data Reader Library -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .mobile-screen {
            width: 100%;
            max-width: 414px;
            height: 800px;
            border: 8px solid #1a202c;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            position: relative;
            background-color: #f8fafc;
        }
        .page-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        /* --- Animation Keyframes --- */
        @keyframes heart-bounce {
            0%, 100% { transform: scale(1); }
            30% { transform: scale(1.3); }
            60% { transform: scale(0.9); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Page Transition --- */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            background-color: inherit;
        }
        .page.is-active {
           opacity: 1;
           pointer-events: auto;
           transform: scale(1);
        }

        .modal-container {
            visibility: hidden; opacity: 0;
            transition: visibility 0s 0.3s, opacity 0.3s linear;
        }
        .modal-container.visible {
            visibility: visible; opacity: 1;
            transition: opacity 0.3s linear;
        }
        #share-modal-panel, #add-member-modal-panel {
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        #share-modal-container.visible #share-modal-panel,
        #add-member-modal-container.visible #add-member-modal-panel {
            transform: translateY(0);
        }
        .photo-carousel::-webkit-scrollbar, .tag-carousel::-webkit-scrollbar, .featured-carousel::-webkit-scrollbar { display: none; }
        .masonry {
            column-count: 2;
            column-gap: 1rem;
            column-fill: balance;
        }
        @media (max-width: 360px) {
            .masonry { column-count: 1; }
        }
        .masonry-item {
            display: inline-block;
            width: 100%;
            margin-bottom: 1rem;
            break-inside: avoid;
        }
        .masonry-item img { width: 100%; height: auto; display: block; }
        .bottom-nav-item.active svg,
        .bottom-nav-item.active p {
            color: #f59e0b; /* amber-500 */
        }
        .like-button .heart-icon {
            fill: none;
            stroke: currentColor;
            transition: all 0.2s ease-in-out;
        }
        .like-button.liked .heart-icon {
            fill: #ef4444; /* red-500 */
            stroke: #ef4444;
            animation: heart-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .explore-tab.active {
            border-bottom-color: #f59e0b;
            color: #0f172a;
        }
        .tab-content.hidden {
            display: none;
        }
        
        /* --- Tab Content Animation --- */
        .tab-content {
            animation: fadeIn 0.4s ease-out;
        }

        .map-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #ef4444;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 2px solid white;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .map-pin::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .spinner-small {
            border: 2px solid rgba(128, 128, 128, 0.3);
            border-top-color: #666;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* --- Timeline Styles --- */
        .timeline-item {
            position: relative;
            padding-left: 30px; 
            padding-bottom: 2rem;
        }
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 8px;
            bottom: -8px; 
            width: 2px;
            background-color: #e2e8f0; /* gray-200 */
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 8px;
            top: 8px;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background-color: #f59e0b; /* amber-500 */
            border: 3px solid white;
            border-radius: 50%;
            z-index: 1;
        }
        .cover-photo {
            border: 4px solid #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .summary-note {
            font-family: 'Zhi Mang Xing', cursive;
            background-color: #fffbeb; /* amber-50 */
            border: 1px solid #fde68a; /* amber-200 */
            padding: 1.5rem;
            padding-top: 2rem;
            border-radius: 4px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.15);
            position: relative;
            transform: rotate(-1.5deg);
            margin: 1.5rem 0.5rem;
        }
        .summary-note::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        /* --- Toast Notification --- */
        #toast-notification.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="mobile-screen">
        <!-- Toast Notification -->
        <div id="toast-notification" class="absolute top-0 left-1/2 -translate-x-1/2 mt-12 px-6 py-3 rounded-full shadow-lg text-white font-semibold text-sm z-50 transition-all duration-300 ease-in-out transform -translate-y-20 opacity-0">
            <p id="toast-message"></p>
        </div>

        <div class="page-container">

            <!-- ================================================== -->
            <!-- =====      ç™»å…¥/è¨»å†Šé  (Auth)          ===== -->
            <!-- ================================================== -->
            <div id="auth-screen" class="page is-active">
                <div class="flex flex-col justify-center items-center h-full p-8 bg-amber-50">
                    <h1 class="text-4xl font-bold text-amber-800 mb-2">å®¶åº­æ™‚å…‰è† å›Š</h1>
                    <p class="text-amber-700 mb-10">çè—æ‚¨çš„å®¶åº­å›æ†¶</p>
                    
                    <div class="w-full max-w-sm">
                        <div class="mb-4">
                            <label for="email" class="block text-amber-800 text-sm font-bold mb-2">é›»å­éƒµä»¶</label>
                            <input type="email" id="email" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-amber-400" placeholder="you@example.com">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-amber-800 text-sm font-bold mb-2">å¯†ç¢¼</label>
                            <input type="password" id="password" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-amber-400" placeholder="******************">
                        </div>
                        <div id="auth-error" class="text-red-500 text-xs italic mb-4 h-4"></div>
                        <div class="flex flex-col space-y-3">
                            <button id="login-button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors flex items-center justify-center">ç™»å…¥</button>
                            <button id="register-button" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors flex items-center justify-center">è¨»å†Šæ–°å¸³è™Ÿ</button>
                            <button id="guest-button" class="text-amber-700 hover:text-amber-900 text-sm font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">è¨ªå®¢ç€è¦½</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ================================================== -->
            <!-- =====        ä¸»ç•«é¢ (Home)             ===== -->
            <!-- ================================================== -->
            <div id="home-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <div><h1 id="greeting" class="text-xl font-bold text-gray-800">æ‚¨å¥½ï¼</h1></div>
                    </div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main id="diaries-container" class="p-4 space-y-6 pb-24">
                        <!-- æ—¥è¨˜å°‡æœƒå‹•æ…‹åœ°æ’å…¥åˆ°é€™è£¡ -->
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      ç¤¾ç¾¤æ¢ç´¢é  (Explore)        ===== -->
            <!-- ================================================== -->
            <div id="explore-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex-shrink-0">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="æœå°‹æ—¥è¨˜ã€å‰µä½œè€…æˆ– #åœ°é»æ¨™ç±¤..." class="w-full bg-gray-100 border border-gray-200 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                    </div>
                </header>
                
                <!-- Tab Navigation -->
                <div class="flex justify-around border-b border-gray-200 bg-white flex-shrink-0">
                    <button data-tab="footprints" class="explore-tab py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent w-full">æœ€è¿‘è¶³è·¡</button>
                    <button data-tab="discover" class="explore-tab py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent w-full active">æ¢ç´¢</button>
                    <button data-tab="following" class="explore-tab py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent w-full">è¿½è¹¤</button>
                </div>

                <div class="overflow-y-auto flex-1">
                    <!-- Discover Content (Original Explore Page) -->
                    <div id="discover-content" class="tab-content">
                        <main class="p-4 pb-24">
                            <h2 class="text-base font-bold text-gray-700 mt-6 mb-3">ç²¾é¸æ—¥è¨˜</h2>
                            <div id="explore-diaries-grid" class="masonry">
                                <!-- Public diaries will be dynamically inserted here -->
                            </div>
                        </main>
                    </div>

                    <!-- Footprints Content -->
                    <div id="footprints-content" class="tab-content hidden">
                        <main class="p-4 pb-24 space-y-4">
                            <div class="relative mb-4 rounded-lg overflow-hidden shadow-md">
                                <img src="https://storage.googleapis.com/gemini-prod-us-west1-423901-8354/images/20240810_taiwan_map_prototype.png" alt="å°ç£è¶³è·¡åœ°åœ–" class="w-full h-48 object-cover">
                                <!-- Map Pins -->
                                <div class="map-pin" style="top: 25%; left: 78%;" title="å°åŒ—å¸‚ï¼Œé™½æ˜å±±"></div>
                                <div class="map-pin" style="top: 35%; left: 85%;" title="å®œè˜­ç¸£ï¼Œå†¬å±±æ²³è¦ªæ°´å…¬åœ’"></div>
                                <div class="map-pin" style="top: 80%; left: 20%;" title="æˆ‘å€‘æº«æš–çš„å®¶ (é«˜é›„)"></div>
                            </div>
                            <div class="flex items-center bg-white p-3 rounded-lg shadow-sm">
                                <img src="https://placehold.co/100x100/34D399/FFFFFF?text=å±±" class="w-16 h-16 rounded-lg object-cover mr-4">
                                <div>
                                    <h3 class="font-bold">é™½æ˜å±±ç¹¡çƒèŠ±ä¹‹æ—…</h3>
                                    <p class="text-sm text-gray-500">2025å¹´8æœˆ4æ—¥</p>
                                    <p class="text-xs text-gray-400">1 å‰‡æ—¥è¨˜</p>
                                </div>
                            </div>
                             <div class="flex items-center bg-white p-3 rounded-lg shadow-sm">
                                <img src="https://placehold.co/100x100/FBBF24/FFFFFF?text=å®¶" class="w-16 h-16 rounded-lg object-cover mr-4">
                                <div>
                                    <h3 class="font-bold">æˆ‘å€‘æº«æš–çš„å®¶</h3>
                                    <p class="text-sm text-gray-500">2025å¹´7æœˆ20æ—¥</p>
                                    <p class="text-xs text-gray-400">3 å‰‡æ—¥è¨˜</p>
                                </div>
                            </div>
                            <div class="flex items-center bg-white p-3 rounded-lg shadow-sm">
                                <img src="https://placehold.co/100x100/60A5FA/FFFFFF?text=æ°´" class="w-16 h-16 rounded-lg object-cover mr-4">
                                <div>
                                    <h3 class="font-bold">å®œè˜­ç¸£å†¬å±±æ²³è¦ªæ°´å…¬åœ’</h3>
                                    <p class="text-sm text-gray-500">2025å¹´7æœˆ5æ—¥</p>
                                    <p class="text-xs text-gray-400">1 å‰‡æ—¥è¨˜</p>
                                </div>
                            </div>
                        </main>
                    </div>

                    <!-- Following Content -->
                    <div id="following-content" class="tab-content hidden">
                        <main class="pb-24">
                            <!-- Stories Section -->
                            <div class="p-4 border-b border-gray-200 bg-white">
                                <h3 class="text-sm font-semibold text-gray-600 mb-3">å³æ™‚å‹•æ…‹</h3>
                                <div class="flex space-x-4 overflow-x-auto pb-2 tag-carousel">
                                    <!-- Story Item with new story -->
                                    <div class="text-center flex-shrink-0 cursor-pointer">
                                        <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover" src="https://placehold.co/100x100/dbeafe/1e3a8a?text=çˆ¸" alt="Creator 2">
                                            <div class="absolute inset-0 rounded-full ring-2 ring-amber-400 ring-offset-2"></div>
                                        </div>
                                        <p class="text-xs mt-2">æ”å½±è€çˆ¸</p>
                                    </div>
                                    <!-- Story Item already viewed -->
                                    <div class="text-center flex-shrink-0 cursor-pointer">
                                         <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover border-2 border-gray-300" src="https://placehold.co/100x100/fde68a/a16207?text=åª½" alt="Creator 1">
                                        </div>
                                        <p class="text-xs mt-2">æ—…è¡Œçš„åª½å’ª</p>
                                    </div>
                                    <div class="text-center flex-shrink-0 cursor-pointer">
                                         <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover border-2 border-gray-300" src="https://placehold.co/100x100/fce7f3/831843?text=å¨ƒ" alt="Creator 3">
                                        </div>
                                        <p class="text-xs mt-2">å¨ƒå¨ƒçœ‹å¤©ä¸‹</p>
                                    </div>
                                     <div class="text-center flex-shrink-0 cursor-pointer">
                                        <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover ring-2 ring-amber-400 ring-offset-2" src="https://placehold.co/100x100/4ade80/ffffff?text=å¯¶" alt="Creator 4">
                                        </div>
                                        <p class="text-xs mt-2">å¯¶å¯¶å»å“ªå…’</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Feed Section -->
                            <div class="p-4 space-y-6">
                                <div class="memory-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer">
                                    <div class="p-4 flex items-center space-x-3 border-b">
                                        <img class="w-10 h-10 rounded-full" src="https://placehold.co/100x100/dbeafe/1e3a8a?text=çˆ¸" alt="Creator 2">
                                        <div>
                                            <p class="font-semibold text-sm">æ”å½±è€çˆ¸</p>
                                            <p class="text-xs text-gray-400">2 å°æ™‚å‰</p>
                                        </div>
                                    </div>
                                    <img src="https://placehold.co/600x400/f87171/ffffff?text=é‡é¤" alt="åŸå¸‚å…¬åœ’çš„åˆå¾Œé‡é¤" class="w-full h-48 object-cover">
                                    <div class="p-4">
                                        <h2 class="text-lg font-bold text-gray-800">åŸå¸‚å…¬åœ’çš„åˆå¾Œé‡é¤</h2>
                                        <p class="text-sm text-gray-600 mt-2">ä»Šå¤©å¤©æ°£çœŸå¥½ï¼Œå¸¶è‘—å®¶äººä¸€èµ·åˆ°å…¬åœ’é‡é¤ï¼Œäº«å—æ‚ é–’çš„åˆå¾Œæ™‚å…‰...</p>
                                    </div>
                                </div>
                                <div class="memory-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer">
                                    <div class="p-4 flex items-center space-x-3 border-b">
                                        <img class="w-10 h-10 rounded-full" src="https://placehold.co/100x100/fde68a/a16207?text=åª½" alt="Creator 1">
                                        <div>
                                            <p class="font-semibold text-sm">æ—…è¡Œçš„åª½å’ª</p>
                                            <p class="text-xs text-gray-400">æ˜¨å¤©</p>
                                        </div>
                                    </div>
                                    <img src="https://placehold.co/600x400/fb923c/ffffff?text=éœ²ç‡Ÿ" alt="æˆ‘å€‘çš„ç¬¬ä¸€æ¬¡æ£®æ—éœ²ç‡Ÿ" class="w-full h-48 object-cover">
                                    <div class="p-4">
                                        <h2 class="text-lg font-bold text-gray-800">æˆ‘å€‘çš„ç¬¬ä¸€æ¬¡æ£®æ—éœ²ç‡Ÿ</h2>
                                        <p class="text-sm text-gray-600 mt-2">å¤œæ™šçš„æ˜Ÿç©ºå¥½ç¾ï¼Œå­©å­å€‘ç¬¬ä¸€æ¬¡çœ‹åˆ°é€™éº¼å¤šæ˜Ÿæ˜Ÿï¼Œéƒ½èˆˆå¥®å¾—ç¡ä¸è‘—è¦ºï¼</p>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            </div>
            
            <!-- ================================================== -->
            <!-- =====      æœå°‹çµæœé  (Search Results)   ===== -->
            <!-- ================================================== -->
            <div id="search-results-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button>
                    <h1 id="search-results-title" class="text-base font-bold text-gray-800 mx-auto">æœå°‹çµæœ</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-4 pb-24">
                        <div id="search-results-grid" class="masonry">
                           <!-- Search results will be injected here -->
                        </div>
                    </main>
                </div>
            </div>


            <!-- ================================================== -->
            <!-- =====    å‰µä½œè€…å€‹äººä¸»é  (Profile)      ===== -->
            <!-- ================================================== -->
            <div id="profile-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button>
                    <h1 class="text-base font-bold text-gray-800 mx-auto">æ—…è¡Œçš„åª½å’ª</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="pb-24">
                        <div class="p-4 text-center bg-white">
                            <img class="w-24 h-24 rounded-full border-4 border-white shadow-lg mx-auto -mt-16" src="https://placehold.co/100x100/fde68a/a16207?text=åª½" alt="Creator 1">
                            <h2 class="text-xl font-bold mt-4">æ—…è¡Œçš„åª½å’ª</h2>
                            <p class="text-sm text-gray-500 mt-1">@travelmom_tw</p>
                            <p class="text-sm text-gray-700 mt-4 max-w-md mx-auto">å¸¶è‘—å…©å€‹å­©å­æ¢ç´¢å°ç£çš„ç¾å¥½è§’è½ã€‚<br>ç†±æ„›éœ²ç‡Ÿã€æ‰‹ä½œèˆ‡å’–å•¡å»³ã€‚</p>
                            <div class="flex justify-center space-x-6 mt-4">
                                <div class="text-center">
                                    <p class="font-bold text-lg">128</p>
                                    <p class="text-xs text-gray-500">æ—¥è¨˜</p>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-lg">15.2k</p>
                                    <p class="text-xs text-gray-500">ç²‰çµ²</p>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-lg">180</p>
                                    <p class="text-xs text-gray-500">è¿½è¹¤ä¸­</p>
                                </div>
                            </div>
                            <button class="mt-6 w-full bg-amber-500 text-white font-bold py-2 rounded-lg">è¿½è¹¤</button>
                        </div>
                        <div class="p-4">
                            <div class="masonry">
                                <div class="masonry-item"><div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer"><img src="https://placehold.co/400x500/fb923c/ffffff?text=éœ²ç‡Ÿ" alt="Diary 1"><div class="p-3"><p class="text-sm font-semibold truncate">æˆ‘å€‘çš„ç¬¬ä¸€æ¬¡æ£®æ—éœ²ç‡Ÿ</p><div class="flex items-center text-xs text-gray-400 mt-2"><span class="mr-3 flex items-center">ğŸ‘ï¸ 8.2k</span><span class="flex items-center">â¤ï¸ 1.2k</span></div></div></div></div>
                                <div class="masonry-item"><div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer"><img src="https://placehold.co/400x600/4ade80/ffffff?text=è¾²å ´" alt="Diary 4"><div class="p-3"><p class="text-sm font-semibold truncate">æ¸…å¢ƒè¾²å ´é¤µç¾Šåˆé«”é©—</p><div class="flex items-center text-xs text-gray-400 mt-2"><span class="mr-3 flex items-center">ğŸ‘ï¸ 9.8k</span><span class="flex items-center">â¤ï¸ 2.3k</span></div></div></div></div>
                                <div class="masonry-item"><div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer"><img src="https://placehold.co/400x400/a78bfa/ffffff?text=å¤è¹Ÿ" alt="Diary 3"><div class="p-3"><p class="text-sm font-semibold truncate">å°å—å¤è¹Ÿæ•£æ­¥</p><div class="flex items-center text-xs text-gray-400 mt-2"><span class="mr-3 flex items-center">ğŸ‘ï¸ 4.1k</span><span class="flex items-center">â¤ï¸ 760</span></div></div></div></div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      å»ºç«‹æ–°æ—¥è¨˜é  (Create)         ===== -->
            <!-- ================================================== -->
            <div id="create-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button>
                    <h1 class="text-base font-bold text-gray-800">å»ºç«‹æ–°çš„å›æ†¶</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-5 pb-24">
                        <h2 class="text-lg font-semibold text-gray-700 mb-3">
                            <span id="photo-count">å·²é¸å–çš„ç…§ç‰‡ (0)</span>
                        </h2>
                        <div id="photo-grid-container" class="grid grid-cols-2 gap-4">
                            <label for="photo-upload" class="aspect-square bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span class="mt-2 text-sm text-gray-500">æ–°å¢ç…§ç‰‡</span>
                            </label>
                        </div>
                        <input type="file" id="photo-upload" multiple accept="image/*" class="hidden">
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">èª°å¯ä»¥çœ‹è¦‹ï¼Ÿ</h3>
                            <select id="privacy-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="private">ğŸ”’ åƒ…é™è‡ªå·±</option>
                                <option value="group">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç‰¹å®šç¾¤çµ„</option>
                                <option value="public">ğŸŒ å…¬é–‹åˆ°ç¤¾ç¾¤</option>
                            </select>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">AI å¯«ä½œé¢¨æ ¼</h3>
                            <div class="space-y-2">
                                <label class="flex items-start p-3 bg-white border-2 border-amber-400 rounded-lg"><input type="radio" name="writing-style" value="warm" class="mt-1 text-amber-500 focus:ring-amber-400" checked><div class="ml-3"><p class="font-semibold">æº«é¦¨æ„Ÿæ€§é¢¨</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="writing-style" value="fun" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">æ´»æ½‘æœ‰è¶£é¢¨</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="writing-style" value="simple" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">ç°¡æ½”ç´€éŒ„é¢¨</p></div></label>
                                <div class="p-3 bg-white border rounded-lg">
                                    <label class="flex items-start"><input type="radio" name="writing-style" value="custom" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3 flex-1"><p class="font-semibold">âœï¸ è‡ªè¨‚é¢¨æ ¼</p><textarea id="custom-prompt" class="w-full mt-2 p-2 border rounded text-sm bg-gray-50" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨å¸Œæœ›çš„å¯«ä½œé¢¨æ ¼æç¤ºè©ï¼Œä¾‹å¦‚ï¼šè«‹ç”¨å¤é¾çš„æ­¦ä¿ å°èªªé¢¨æ ¼ä¾†å¯«..." disabled></textarea></div></label>
                                </div>
                            </div>
                        </div>
                        <div id="create-error" class="text-red-500 text-xs italic mt-4 h-4 text-center"></div>
                    </main>
                </div>
                <footer class="p-5 bg-white/80 backdrop-blur-sm border-t border-gray-200 flex-shrink-0">
                    <button id="generate-diary-button" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600 transition-all disabled:bg-gray-300 disabled:shadow-none flex items-center justify-center" disabled>
                        âœ¨ AI è‡ªå‹•ç”Ÿæˆæ—¥è¨˜
                    </button>
                </footer>
            </div>

            <!-- ================================================== -->
            <!-- =====      æ—¥è¨˜è©³æƒ…é  (Detail)           ===== -->
            <!-- ================================================== -->
            <div id="detail-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-20 flex justify-between items-center border-b border-gray-200 flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button>
                    
                    <!-- Center Content -->
                    <div class="flex-1 flex flex-col justify-center items-center overflow-hidden h-full">
                        <div id="detail-header-content" class="flex items-center space-x-2">
                            <img id="detail-author-avatar" class="w-6 h-6 rounded-full bg-gray-200" style="display: none;">
                            <p id="detail-header-text" class="text-2xl font-bold text-gray-800 truncate"></p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2 w-20 justify-end">
                        <button id="share-button" class="text-gray-600 hover:text-gray-900 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg></button>
                        <button id="edit-button" class="text-gray-600 hover:text-gray-900 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    </div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main id="detail-content-container" class="pb-6">
                        <!-- Diary content will be dynamically inserted here -->
                    </main>
                </div>
                <div id="share-modal-container" class="modal-container absolute inset-0 z-30"><div id="share-modal-backdrop" class="absolute inset-0 bg-black/40"></div><div id="share-modal-panel" class="absolute bottom-0 left-0 right-0 bg-slate-50 rounded-t-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold text-gray-900">åˆ†äº«é€™ä»½å›æ†¶</h2><button id="close-modal-button" class="text-gray-400 hover:text-gray-700">&times;</button></div>
                <div class="mt-4">
                    <h3 class="text-base font-semibold text-gray-800 mb-3">åˆ†äº«çµ¦ç¾¤çµ„</h3>
                    <div class="space-y-2">
                        <button class="share-group-button w-full text-left bg-white p-3 rounded-lg border flex items-center"><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span><span class="ml-3">å®¶äººç¾¤çµ„</span></button>
                        <button class="share-group-button w-full text-left bg-white p-3 rounded-lg border flex items-center"><span>ğŸ§‘â€ğŸ¤â€ğŸ§‘</span><span class="ml-3">æœ‹å‹ç¾¤çµ„</span></button>
                        <button class="share-group-button w-full text-left bg-white p-3 rounded-lg border flex items-center"><span>ğŸ•ï¸</span><span class="ml-3">éœ²ç‡Ÿå¥½å¤¥ä¼´</span></button>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-lg border mt-4"><p class="text-xs text-gray-500 mb-2">æˆ–è¤‡è£½ç§å¯†é€£çµï¼š</p><div class="flex items-center space-x-2"><input type="text" value="https://our-app.com/diary/xyz123" class="text-sm text-gray-600 bg-gray-100 p-2 rounded w-full truncate" readonly><button id="copy-link-button" class="bg-amber-500 text-white px-3 py-2 rounded-md text-sm font-semibold whitespace-nowrap">è¤‡è£½</button></div></div><div class="mt-6"><button id="done-button" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-gray-900">å®Œæˆ</button></div></div></div>
            </div>

            <!-- ================================================== -->
            <!-- =====      ç·¨è¼¯æ—¥è¨˜é  (Edit)           ===== -->
            <!-- ================================================== -->
            <div id="edit-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900">è¿”å›</button>
                    <h1 class="text-base font-bold text-gray-800">ç·¨è¼¯æ—¥è¨˜</h1>
                    <button id="save-button" class="text-amber-500 font-bold">å„²å­˜</button>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-5">
                        <div class="mb-6">
                            <label class="text-lg font-semibold text-gray-700">æ¨™é¡Œ</label>
                            <input type="text" id="edit-title" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                        </div>
                        <div class="mb-6">
                            <label class="text-lg font-semibold text-gray-700">ç¸½çµæ•…äº‹</label>
                            <textarea id="edit-overall-story" class="w-full mt-2 p-3 border border-gray-300 rounded-lg h-24 focus:ring-2 focus:ring-amber-400 focus:border-amber-400"></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="text-lg font-semibold text-gray-700 mb-2">èª°å¯ä»¥çœ‹è¦‹ï¼Ÿ</label>
                            <select id="edit-privacy-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="private">ğŸ”’ åƒ…é™è‡ªå·±</option>
                                <option value="group">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç‰¹å®šç¾¤çµ„</option>
                                <option value="public">ğŸŒ å…¬é–‹åˆ°ç¤¾ç¾¤</option>
                            </select>
                        </div>
                        <hr class="my-6">
                        <div id="edit-events-container" class="space-y-6">
                            <!-- Dynamic event editors will be inserted here -->
                        </div>
                        <hr class="my-8 border-dashed">
                        <div id="edit-style-container" class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">AI é¢¨æ ¼é‡å¡‘</h3>
                             <div class="space-y-2">
                                <label class="flex items-start p-3 bg-white border-2 border-amber-400 rounded-lg"><input type="radio" name="edit-writing-style" value="warm" class="mt-1 text-amber-500 focus:ring-amber-400" checked><div class="ml-3"><p class="font-semibold">æº«é¦¨æ„Ÿæ€§é¢¨</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="edit-writing-style" value="fun" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">æ´»æ½‘æœ‰è¶£é¢¨</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="edit-writing-style" value="simple" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">ç°¡æ½”ç´€éŒ„é¢¨</p></div></label>
                            </div>
                            <button id="regenerate-button" class="mt-4 w-full bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-600 transition-all flex items-center justify-center">
                                âœ¨ å¥—ç”¨æ–°é¢¨æ ¼é‡å¯«
                            </button>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      ç”Ÿæˆä¸­... (Loading)           ===== -->
            <!-- ================================================== -->
            <div id="loading-screen" class="page">
                <div class="m-auto text-center p-8"><div class="bg-amber-400 p-8 rounded-2xl"><svg class="animate-spin h-12 w-12 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><h2 class="text-2xl font-bold mt-6 text-white">AI æ­£åœ¨ç‚ºæ‚¨æ’°å¯«æ•…äº‹...</h2><p id="countdown-timer" class="mt-2 text-white/80">è«‹ç¨å€™...</p></div></div>
            </div>
            
            <!-- ================================================== -->
            <!-- =====      è¨­å®šé  (Settings)             ===== -->
            <!-- ================================================== -->
            <div id="pro-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button>
                    <h1 class="text-base font-bold text-gray-800 mx-auto">è¨­å®š</h1>
                    <div class="w-20"></div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <button id="go-to-profile-edit" class="w-full text-left bg-white p-4 rounded-lg border flex items-center mb-8">
                            <img id="settings-avatar" class="w-12 h-12 rounded-full" src="https://placehold.co/100x100/e2e8f0/475569?text=?" alt="User Avatar">
                            <div class="ml-4 flex-1">
                                <p id="settings-display-name" class="font-bold">è¨ªå®¢</p>
                                <p id="settings-username" class="text-xs text-gray-500">@guest</p>
                            </div>
                            <span>&gt;</span>
                        </button>
                        <div class="mt-8 space-y-2">
                             <button id="go-to-earnings" class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>ğŸ’° å‰µä½œè€…æ”¶ç›Šä¸­å¿ƒ</span><span>&gt;</span></button>
                             <button id="go-to-groups" class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ç®¡ç†æˆ‘çš„ç¾¤çµ„</span><span>&gt;</span></button>
                             <button id="go-to-writing-style" class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>âœï¸ AI å¯«ä½œé¢¨æ ¼</span><span>&gt;</span></button>
                             <button class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>ğŸ”” é€šçŸ¥è¨­å®š</span><span>&gt;</span></button>
                             <button id="logout-button" class="w-full text-left text-red-500 bg-white p-4 rounded-lg border">ç™»å‡ºå¸³è™Ÿ</button>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    å‰µä½œè€…æ”¶ç›Šé  (Earnings)       ===== -->
            <!-- ================================================== -->
            <div id="earnings-screen" class="page">
                 <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button><h1 class="text-base font-bold text-gray-800 mx-auto">å‰µä½œè€…æ”¶ç›Š</h1><div class="w-20"></div></header>
                 <div class="overflow-y-auto flex-1">
                       <main class="p-6">
                           <div class="bg-white p-5 rounded-xl shadow-lg text-center">
                               <p class="text-sm text-gray-500">ç›®å‰ç¸½æ”¶ç›Š</p>
                               <p class="text-4xl font-bold text-gray-800 my-2">NT$ 850</p>
                               <button class="bg-green-500 text-white font-bold py-2 px-8 rounded-full">æé ˜</button>
                           </div>
                           <div class="grid grid-cols-2 gap-4 mt-6">
                               <div class="bg-white p-3 rounded-xl shadow"><p class="text-xs text-gray-500">ä»Šæ—¥é ä¼°æ”¶ç›Š</p><p class="font-bold text-lg">NT$ 15</p></div>
                               <div class="bg-white p-3 rounded-xl shadow"><p class="text-xs text-gray-500">æœ¬æœˆç´¯è¨ˆ</p><p class="font-bold text-lg">NT$ 320</p></div>
                           </div>
                           <div class="mt-8">
                               <h3 class="font-bold mb-2">æ”¶ç›Šè¶¨å‹¢ (è¿‘30æ—¥)</h3>
                               <div class="bg-white p-4 rounded-xl shadow">
                                   <img src="https://placehold.co/600x200/f0f9ff/0284c7?text=æ”¶ç›Šè¶¨å‹¢åœ–" alt="æ”¶ç›Šè¶¨å‹¢åœ–" class="w-full">
                               </div>
                           </div>
                           <div class="mt-8">
                               <h3 class="font-bold mb-2">ç†±é–€æ—¥è¨˜æ’è¡Œæ¦œ</h3>
                               <div class="space-y-3">
                                   <div class="bg-white p-3 rounded-xl shadow flex items-center space-x-3">
                                       <img src="https://placehold.co/100x100/34D399/FFFFFF?text=è¦ªå­" class="w-16 h-16 rounded-lg object-cover">
                                       <div class="flex-1"><p class="font-bold text-sm">é™½æ˜å±±ç¹¡çƒèŠ±ä¹‹æ—…</p><p class="text-xs text-gray-500">è§€çœ‹ 8.2kæ¬¡ãƒ»æ”¶ç›Š NT$ 125</p></div>
                                   </div>
                                    <div class="bg-white p-3 rounded-xl shadow flex items-center space-x-3">
                                       <img src="https://placehold.co/100x100/fb923c/ffffff?text=éœ²ç‡Ÿ" class="w-16 h-16 rounded-lg object-cover">
                                       <div class="flex-1"><p class="font-bold text-sm">æˆ‘å€‘çš„ç¬¬ä¸€æ¬¡æ£®æ—éœ²ç‡Ÿ</p><p class="text-xs text-gray-500">è§€çœ‹ 6.5kæ¬¡ãƒ»æ”¶ç›Š NT$ 98</p></div>
                                   </div>
                               </div>
                           </div>
                       </main>
                 </div>
            </div>
            
            <!-- ================================================== -->
            <!-- =====      ç®¡ç†ç¾¤çµ„é  (Groups)           ===== -->
            <!-- ================================================== -->
            <div id="groups-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button><h1 class="text-base font-bold text-gray-800 mx-auto">ç®¡ç†æˆ‘çš„ç¾¤çµ„</h1><div class="w-20"></div></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div class="space-y-3">
                            <button class="group-item w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><div><p>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶äººç¾¤çµ„</p><p class="text-xs text-gray-500">5 ä½æˆå“¡</p></div><span>&gt;</span></button>
                            <button class="group-item w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><div><p>ğŸ§‘â€ğŸ¤â€ğŸ§‘ æœ‹å‹ç¾¤çµ„</p><p class="text-xs text-gray-500">12 ä½æˆå“¡</p></div><span>&gt;</span></button>
                            <button class="group-item w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><div><p>ğŸ•ï¸ éœ²ç‡Ÿå¥½å¤¥ä¼´</p><p class="text-xs text-gray-500">8 ä½æˆå“¡</p></div><span>&gt;</span></button>
                        </div>
                        <button id="create-group-button" class="mt-6 w-full bg-amber-500 text-white font-bold py-3 rounded-lg">å»ºç«‹æ–°ç¾¤çµ„</button>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    ç·¨è¼¯ç¾¤çµ„é  (Group Edit)       ===== -->
            <!-- ================================================== -->
            <div id="group-edit-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button><h1 class="text-base font-bold text-gray-800">ç·¨è¼¯ç¾¤çµ„</h1><button class="text-amber-500 font-bold w-12 text-right">å„²å­˜</button></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div>
                            <label class="text-lg font-semibold text-gray-700">ç¾¤çµ„åç¨±</label>
                            <input type="text" value="å®¶äººç¾¤çµ„" class="w-full mt-2 p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mt-6">
                             <h3 class="text-lg font-semibold text-gray-700 mb-2">æˆå“¡ (5)</h3>
                             <div class="space-y-2">
                                 <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                                     <div class="flex items-center"><img src="https://placehold.co/100x100/fde68a/a16207?text=å¬¤" class="w-10 h-10 rounded-full mr-3"><span>é˜¿å¬¤</span></div>
                                     <button class="text-red-500">ç§»é™¤</button>
                                 </div>
                                 <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                                     <div class="flex items-center"><img src="https://placehold.co/100x100/dbeafe/1e3a8a?text=çˆ¸" class="w-10 h-10 rounded-full mr-3"><span>çˆ¸çˆ¸</span></div>
                                     <button class="text-red-500">ç§»é™¤</button>
                                 </div>
                             </div>
                        </div>
                        <button id="add-member-button" class="mt-6 w-full bg-blue-500 text-white font-bold py-3 rounded-lg">ï¼‹ æ–°å¢æˆå“¡</button>
                        <button class="mt-8 w-full text-red-500 font-semibold py-2">åˆªé™¤ç¾¤çµ„</button>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====  å»ºç«‹æ–°ç¾¤çµ„é  (Group Create)     ===== -->
            <!-- ================================================== -->
            <div id="group-create-screen" class="page">
                 <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button><h1 class="text-base font-bold text-gray-800">å»ºç«‹æ–°ç¾¤çµ„</h1><button class="text-amber-500 font-bold w-12 text-right">å»ºç«‹</button></header>
                 <div class="overflow-y-auto flex-1">
                       <main class="p-6">
                           <div class="flex flex-col items-center">
                               <button id="emoji-picker-button" class="text-6xl bg-white rounded-full h-24 w-24 flex items-center justify-center shadow-md mb-4">ğŸ½ï¸</button>
                               <input type="text" placeholder="è«‹è¼¸å…¥ç¾¤çµ„åç¨±" class="w-full text-center text-xl font-bold p-2 border-b-2 focus:outline-none focus:border-amber-500">
                           </div>
                           <div class="mt-8">
                               <h3 class="text-lg font-semibold text-gray-700 mb-2">æ–°å¢æˆå“¡</h3>
                               <div class="relative"><input type="text" placeholder="æœå°‹ä½¿ç”¨è€…åç¨±..." class="w-full bg-white border border-gray-200 rounded-full py-2 pl-10 pr-4"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div></div>
                           </div>
                       </main>
                 </div>
            </div>

             <!-- ================================================== -->
            <!-- =====    ç·¨è¼¯å€‹äººè³‡æ–™é  (Profile Edit)   ===== -->
            <!-- ================================================== -->
            <div id="profile-edit-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button><h1 class="text-base font-bold text-gray-800">ç·¨è¼¯å€‹äººè³‡æ–™</h1><button id="save-profile-button" class="text-amber-500 font-bold w-12 text-right">å„²å­˜</button></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div class="flex flex-col items-center">
                            <div class="relative">
                                <img id="profile-edit-avatar" class="w-24 h-24 rounded-full" src="https://placehold.co/100x100/fde68a/a16207?text=æ—" alt="User Avatar">
                                <button class="absolute -bottom-1 -right-1 bg-white rounded-full p-1 border shadow"><svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                            </div>
                        </div>
                        <div class="mt-8 space-y-4">
                            <div><label class="text-sm font-semibold text-gray-600">ä½¿ç”¨è€…åç¨±</label><input type="text" id="profile-edit-username" class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                            <div><label class="text-sm font-semibold text-gray-600">é¡¯ç¤ºåç¨±</label><input type="text" id="profile-edit-display-name" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></div>
                            <div><label class="text-sm font-semibold text-gray-600">å€‹äººç°¡ä»‹</label><textarea id="profile-edit-bio" class="w-full mt-1 p-2 border border-gray-300 rounded-lg h-24"></textarea></div>
                            <div><label class="text-sm font-semibold text-gray-600">é›»å­éƒµä»¶</label><input type="email" id="profile-edit-email" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></div>
                            <button class="w-full text-blue-600 text-left pt-2">æ›´æ”¹å¯†ç¢¼</button>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    AI å¯«ä½œé¢¨æ ¼é  (Writing Style)   ===== -->
            <!-- ================================================== -->
            <div id="writing-style-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button><h1 class="text-base font-bold text-gray-800 mx-auto">AI å¯«ä½œé¢¨æ ¼</h1><div class="w-20"></div></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div class="space-y-3">
                            <label class="flex items-start p-4 bg-white border-2 border-amber-400 rounded-lg"><input type="radio" name="writing-style-option" class="mt-1 text-amber-500 focus:ring-amber-400" checked><div class="ml-3"><p class="font-semibold">æº«é¦¨æ„Ÿæ€§é¢¨</p><p class="text-sm text-gray-500">å……æ»¿æº«åº¦èˆ‡æƒ…æ„Ÿï¼Œé©åˆè¨˜éŒ„å®¶åº­çš„æº«æš–ç¬é–“ã€‚</p></div></label>
                            <label class="flex items-start p-4 bg-white border rounded-lg"><input type="radio" name="writing-style-option" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">æ´»æ½‘æœ‰è¶£é¢¨</p><p class="text-sm text-gray-500">ç”¨å­—ä¿çš®ï¼Œå¤šç”¨é©šå˜†è™Ÿï¼Œé©åˆè¨˜éŒ„æ­¡æ¨‚çš„å‡ºéŠã€‚</p></div></label>
                            <label class="flex items-start p-4 bg-white border rounded-lg"><input type="radio" name="writing-style-option" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">ç°¡æ½”ç´€éŒ„é¢¨</p><p class="text-sm text-gray-500">åƒæ—…éŠé›œèªŒèˆ¬ï¼Œå®¢è§€è¨˜éŒ„æ™‚é–“ã€åœ°é»èˆ‡äº‹ä»¶ã€‚</p></div></label>
                             <label class="flex items-start p-4 bg-white border rounded-lg">
                                 <input type="radio" name="writing-style-option" value="custom" class="mt-1 text-amber-500 focus:ring-amber-400">
                                 <div class="ml-3 flex-1">
                                     <p class="font-semibold">âœï¸ è‡ªè¨‚é¢¨æ ¼</p>
                                     <textarea id="custom-prompt-style" class="w-full mt-2 p-2 border rounded text-sm bg-gray-50" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨å¸Œæœ›çš„å¯«ä½œé¢¨æ ¼æç¤ºè©ï¼Œä¾‹å¦‚ï¼šè«‹ç”¨å¤é¾çš„æ­¦ä¿ å°èªªé¢¨æ ¼ä¾†å¯«..." disabled></textarea>
                                 </div>
                             </label>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====  äº’å‹•å¼æå•é  (Interactive Question) ===== -->
            <!-- ================================================== -->
            <div id="interactive-question-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-end items-center flex-shrink-0"><button id="skip-question-button" class="text-gray-500 hover:text-gray-800">è·³é</button></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6 text-center flex flex-col justify-center h-full">
                        <div class="flex-grow">
                            <p class="text-lg text-gray-600 mb-4">AI åµæ¢ç™¼ç¾...</p>
                            <div class="flex -space-x-4 justify-center mb-6">
                                <img class="w-16 h-16 rounded-full border-2 border-white object-cover" src="https://placehold.co/100x100/34D399/FFFFFF?text=1">
                                <img class="w-16 h-16 rounded-full border-2 border-white object-cover" src="https://placehold.co/100x100/A78BFA/FFFFFF?text=2">
                                <img class="w-16 h-16 rounded-full border-2 border-white object-cover" src="https://placehold.co/100x100/FBCFE8/FFFFFF?text=3">
                            </div>
                            <p class="text-xl font-semibold text-gray-800">ä½ å€‘åœ¨èŠ±æµ·ä¸­ç¬‘å¾—å¥½é–‹å¿ƒï¼</p>
                            <p class="text-xl font-semibold text-gray-800 mt-1">é‚£å¤©æœ€é›£å¿˜çš„ç¬é–“æ˜¯ä»€éº¼å‘¢ï¼Ÿ</p>
                            <textarea class="w-full mt-6 p-3 border border-gray-300 rounded-lg h-28" placeholder="å‘Šè¨´ AI æ›´å¤šç´°ç¯€ï¼Œè®“æ•…äº‹æ›´ç²¾å½©..."></textarea>
                        </div>
                        <button id="continue-generation-button" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg mt-6">ç¹¼çºŒç”Ÿæˆ</button>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      å†’éšªé  (Adventure)          ===== -->
            <!-- ================================================== -->
            <div id="adventure-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h1 class="text-xl font-bold text-gray-800">è¦ªå­å¤§å†’éšª</h1>
                    </div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-4 space-y-4 pb-24">
                        <!-- Adventure Card 1 -->
                        <div class="adventure-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
                            <div class="p-4">
                                <div class="flex items-start space-x-4">
                                    <div class="text-4xl">ğŸ™ï¸</div>
                                    <div class="flex-1">
                                        <h2 class="text-lg font-bold text-gray-800">åŸå¸‚å…‰å½±çµäºº</h2>
                                        <p class="text-sm text-gray-600 mt-1">å¸¶è‘—ç›¸æ©Ÿï¼Œæ•æ‰åŸå¸‚è£¡æœ€ç‰¹åˆ¥çš„5å€‹å…‰å½±ç¬é–“ã€‚</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                            <div class="bg-amber-500 h-2.5 rounded-full" style="width: 40%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">é€²åº¦: 2 / 5 å€‹ä»»å‹™</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Adventure Card 2 -->
                        <div class="adventure-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
                            <div class="p-4">
                                <div class="flex items-start space-x-4">
                                    <div class="text-4xl">ğŸ³</div>
                                    <div class="flex-1">
                                        <h2 class="text-lg font-bold text-gray-800">é€±æœ«é‡ç‚Šç‹</h2>
                                        <p class="text-sm text-gray-600 mt-1">å¾æ¡è²·åˆ°çƒ¹é£ªï¼Œå®Œæˆä¸€é“å…¨å®¶å…±äº«çš„æˆ¶å¤–æ–™ç†ï¼</p>
                                         <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                            <div class="bg-amber-500 h-2.5 rounded-full" style="width: 80%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">é€²åº¦: 4 / 5 å€‹ä»»å‹™</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <!-- Adventure Card 3 -->
                        <div class="adventure-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
                            <div class="p-4">
                                <div class="flex items-start space-x-4">
                                    <div class="text-4xl">ğŸ—ºï¸</div>
                                    <div class="flex-1">
                                        <h2 class="text-lg font-bold text-gray-800">ç¤¾å€å°‹å¯¶å®¶</h2>
                                        <p class="text-sm text-gray-600 mt-1">æ‰¾å‡ºç¤¾å€è£¡5å€‹éš±è—çš„ç‰¹æ®Šåœ°æ¨™æˆ–ç¬¦è™Ÿã€‚</p>
                                         <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                            <div class="bg-amber-500 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">é€²åº¦: 0 / 5 å€‹ä»»å‹™</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    å†’éšªè©³æƒ…é  (Adventure Detail)   ===== -->
            <!-- ================================================== -->
            <div id="adventure-detail-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>è¿”å›</span></button>
                    <h1 class="text-base font-bold text-gray-800 mx-auto">åŸå¸‚å…‰å½±çµäºº</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="pb-24">
                        <img src="https://placehold.co/600x300/fbbf24/ffffff?text=åŸå¸‚å…‰å½±" alt="Adventure Banner" class="w-full h-48 object-cover">
                        <div class="p-5">
                            <p class="text-gray-700 leading-relaxed">å…‰å’Œå½±æ˜¯åŸå¸‚è£¡æœ€ç¥å¥‡çš„é­”æ³•å¸«ã€‚å®ƒå€‘èƒ½æŠŠå¹³å‡¡çš„è¡—é“è®Šæˆä¸€å¹…ç•«ï¼ŒæŠŠæ™®é€šçš„å»ºç¯‰è®Šæˆä¸€åº§é›•å¡‘ã€‚é€™æ¬¡çš„å†’éšªï¼Œæˆ‘å€‘è¦åŒ–èº«ç‚ºã€Œå…‰å½±çµäººã€ï¼Œç”¨çœ¼ç›å’Œç›¸æ©Ÿï¼Œå»ç™¼ç¾ä¸¦æ•æ‰é‚£äº›è—åœ¨åŸå¸‚è§’è½ã€ç¨ç¸±å³é€çš„ç¾éº—ç¬é–“ã€‚</p>
                            
                            <h3 class="text-lg font-bold text-gray-800 mt-6 mb-3">ä»»å‹™æ¸…å–® (2/5)</h3>
                            <div class="space-y-3">
                                <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400" checked>
                                    <span class="ml-3 text-gray-800">æ‰¾åˆ°ä¸€å€‹è¢«é™½å…‰æ‹‰å¾—é•·é•·çš„å½±å­</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400" checked>
                                    <span class="ml-3 text-gray-800">æ‹ä¸‹ä¸€å¼µçª—æˆ¶çš„å€’å½±</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400">
                                    <span class="ml-3 text-gray-800">æ•æ‰ç©¿éæ¨¹è‘‰çš„æ–‘é§å…‰é»</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400">
                                    <span class="ml-3 text-gray-800">å°‹æ‰¾å¤œæ™šéœ“è™¹ç‡ˆåœ¨æ¿•åœ°ä¸Šçš„å€’å½±</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400">
                                    <span class="ml-3 text-gray-800">æ‹ä¸‹å¤•é™½æ™‚åˆ†å»ºç¯‰ç‰©çš„é‡‘è‰²è¼ªå»“</span>
                                </label>
                            </div>

                            <h3 class="text-lg font-bold text-gray-800 mt-8 mb-3">æˆæœå±•ç¤º</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <img src="https://placehold.co/200x200/fb923c/ffffff?text=å½±å­" class="rounded-lg object-cover aspect-square">
                                <img src="https://placehold.co/200x200/f87171/ffffff?text=å€’å½±" class="rounded-lg object-cover aspect-square">
                                <div class="aspect-square bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer">
                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                </div>
                            </div>
                             <button class="mt-8 w-full bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-600 transition-all">
                                ğŸ‰ æˆ‘å®Œæˆå†’éšªäº†ï¼
                            </button>
                        </div>
                    </main>
                </div>
            </div>


            <!-- ===== åº•éƒ¨å°è¦½åˆ— ===== -->
            <nav id="bottom-nav" class="absolute bottom-0 left-0 right-0 h-20 bg-white/90 backdrop-blur-sm border-t border-gray-200 flex justify-around items-center z-20" style="display: none;">
                <button data-target="home-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><p class="text-xs mt-1">é¦–é </p></button>
                <button data-target="explore-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3" /></svg><p class="text-xs mt-1">æ¢ç´¢</p></button>
                <button id="fab-nav" class="bg-amber-500 hover:bg-amber-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center transform -mt-8"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                <button data-target="adventure-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v.01M12 12v.01M12 16v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-xs mt-1">å†’éšª</p></button>
                <button data-target="pro-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><p class="text-xs mt-1">è¨­å®š</p></button>
            </nav>
            
            <!-- ===== æ–°å¢æˆå“¡å½ˆçª— ===== -->
            <div id="add-member-modal-container" class="modal-container absolute inset-0 z-40"><div id="add-member-modal-backdrop" class="absolute inset-0 bg-black/40"></div><div id="add-member-modal-panel" class="absolute bottom-0 left-0 right-0 bg-slate-50 rounded-t-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold text-gray-900">æ–°å¢æˆå“¡</h2><button id="close-add-member-modal-button" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button></div><div class="relative"><input type="text" placeholder="æœå°‹ä½¿ç”¨è€…åç¨±..." class="w-full bg-white border border-gray-200 rounded-full py-2 pl-10 pr-4"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div></div><div class="mt-4 space-y-2"><div class="bg-white p-3 rounded-lg border flex justify-between items-center"><div class="flex items-center"><img src="https://placehold.co/100x100/dbeafe/1e3a8a?text=çˆ¸" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">æ”å½±è€çˆ¸</p><p class="text-xs text-gray-500">@photodad</p></div></div><button class="invite-button bg-blue-500 text-white text-sm font-semibold px-3 py-1 rounded-full">é‚€è«‹</button></div><div class="bg-white p-3 rounded-lg border flex justify-between items-center"><div class="flex items-center"><img src="https://placehold.co/100x100/fce7f3/831843?text=å¨ƒ" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">å¨ƒå¨ƒçœ‹å¤©ä¸‹</p><p class="text-xs text-gray-500">@wawaworld</p></div></div><button class="bg-gray-200 text-gray-500 text-sm font-semibold px-3 py-1 rounded-full cursor-not-allowed">å·²é‚€è«‹</button></div></div>
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-500 mb-2">æˆ–</p>
                    <button id="generate-invite-link" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg">ç”¢ç”Ÿé‚€è«‹é€£çµ</button>
                    <div id="invite-link-details" class="hidden mt-4 bg-white p-4 rounded-lg text-left">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://our-app.com/join/abcde" class="mx-auto my-2">
                        <div class="flex items-center space-x-2 mt-2"><input type="text" value="https://our-app.com/join/abcde" class="text-sm text-gray-600 bg-gray-100 p-2 rounded w-full truncate" readonly><button id="copy-invite-link-button" class="bg-amber-500 text-white px-3 py-2 rounded-md text-sm font-semibold whitespace-nowrap">è¤‡è£½</button></div>
                        <div class="mt-4 space-y-2 text-sm">
                            <div class="flex justify-between items-center"><label for="expire-select">æœ‰æ•ˆæœŸ</label><select id="expire-select" class="border rounded p-1"><option>1 å¤©</option><option>7 å¤©</option><option>æ°¸ä¹…</option></select></div>
                            <div class="flex justify-between items-center"><label for="limit-select">ä½¿ç”¨æ¬¡æ•¸</label><select id="limit-select" class="border rounded p-1"><option>5 æ¬¡</option><option>10 æ¬¡</option><option>ç„¡é™åˆ¶</option></select></div>
                        </div>
                    </div>
                </div>
            </div></div>

            <!-- ===== è¨ªå®¢æç¤ºå½ˆçª— ===== -->
            <div id="guest-modal" class="modal-container absolute inset-0 z-50 flex items-center justify-center p-8">
                <div class="absolute inset-0 bg-black/40"></div>
                <div class="relative bg-white rounded-2xl p-6 text-center shadow-xl">
                    <h2 class="text-lg font-bold text-gray-800">éœ€è¦ç™»å…¥å–”ï¼</h2>
                    <p class="text-sm text-gray-600 mt-2">ç‚ºäº†ç¢ºä¿æ‚¨çš„çè²´å›æ†¶ä¸æœƒéºå¤±ï¼Œå»ºç«‹æ—¥è¨˜éœ€è¦ä¸€å€‹æ­£å¼å¸³è™Ÿã€‚</p>
                    <div class="mt-6 flex flex-col space-y-2">
                        <button id="go-to-auth-button" class="w-full bg-amber-500 text-white font-bold py-2 px-4 rounded-lg">å‰å¾€ç™»å…¥ / è¨»å†Š</button>
                        <button id="close-guest-modal-button" class="w-full text-gray-500 text-sm py-2 px-4 rounded-lg">ç¨å¾Œå†èªª</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove, orderBy, setLogLevel, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAoVd0MJy5TjwuEF8xPntGmyu3tpHEUuts",
            authDomain: "family-time-capsule-ac438.firebaseapp.com",
            projectId: "family-time-capsule-ac438",
            storageBucket: "family-time-capsule-ac438.appspot.com",
            messagingSenderId: "717537356458",
            appId: "1:717537356458:web:59caf3c60cd45d2529bed3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        setLogLevel('debug'); // Enable debug logging for Firebase

        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.bottom-nav-item');
        const bottomNav = document.getElementById('bottom-nav');
        const greeting = document.getElementById('greeting');
        const authError = document.getElementById('auth-error');
        const createError = document.getElementById('create-error');
        const guestModal = document.getElementById('guest-modal');
        const diariesContainer = document.getElementById('diaries-container');
        
        let navigationStack = ['auth-screen']; // Start with auth screen
        let diariesUnsubscribe = null; // To hold the listener unsubscribe function
        let commentsUnsubscribe = null; // To hold the listener for comments
        let userProfileUnsubscribe = null;
        let currentUserProfile = null;
        let selectedFiles = []; // To store selected files globally
        let currentDiary = null; // To hold the currently viewed diary object
        let selectedCoverIndex = 0; // To store the user-selected cover photo index
        const userProfileCache = {}; // Cache for author profiles

        async function getAuthorProfile(authorId) {
            if (userProfileCache[authorId]) {
                return userProfileCache[authorId];
            }
            try {
                const userDocRef = doc(db, "users", authorId);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const profile = docSnap.data();
                    userProfileCache[authorId] = profile;
                    return profile;
                }
            } catch (e) {
                console.error("Could not fetch author profile:", e);
            }
            return null;
        }

        function showPage(targetId, isSubPage = false) {
            pages.forEach(page => {
                page.classList.toggle('is-active', page.id === targetId);
            });
            
            const showNav = !isSubPage && targetId !== 'auth-screen';
            bottomNav.style.display = showNav ? 'flex' : 'none';
        }
        
        function navigateTo(targetId) {
            const isSubPage = !['home-screen', 'explore-screen', 'auth-screen', 'adventure-screen', 'pro-screen'].includes(targetId);
            showPage(targetId, isSubPage);
            if (navigationStack[navigationStack.length - 1] !== targetId) {
                navigationStack.push(targetId);
            }
        }

        function goBack() {
            if (commentsUnsubscribe) {
                commentsUnsubscribe();
                commentsUnsubscribe = null;
            }
            if (navigationStack.length > 1) {
                navigationStack.pop();
                const targetId = navigationStack[navigationStack.length - 1];
                const isSubPage = !['home-screen', 'explore-screen', 'auth-screen', 'adventure-screen', 'pro-screen'].includes(targetId);
                showPage(targetId, isSubPage);
                navItems.forEach(nav => {
                    nav.classList.toggle('active', nav.dataset.target === targetId);
                });
            }
        }
        
        function renderComments(comments) {
            const commentsList = document.getElementById('comments-list');
            if (!commentsList) return;
            commentsList.innerHTML = '';
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">é‚„æ²’æœ‰ä»»ä½•ç•™è¨€ã€‚</p>';
                return;
            }
            comments.forEach(comment => {
                const date = comment.createdAt ? comment.createdAt.toDate().toLocaleString('zh-TW') : '';
                const commentEl = document.createElement('div');
                commentEl.className = 'flex items-start space-x-3';
                let imageHTML = '';
                if (comment.imageUrl) {
                    imageHTML = `<img src="${comment.imageUrl}" class="mt-2 rounded-lg max-w-full h-auto" style="max-height: 150px;">`;
                }
                commentEl.innerHTML = `
                    <img class="w-8 h-8 rounded-full" src="https://placehold.co/100x100/e2e8f0/475569?text=${comment.authorName.charAt(0)}" alt="${comment.authorName}">
                    <div class="flex-1">
                        <div class="bg-gray-100 rounded-lg p-3">
                            <p class="font-semibold text-sm">${comment.authorName}</p>
                            <p class="text-sm text-gray-800">${comment.text}</p>
                            ${imageHTML}
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${date}</p>
                    </div>
                `;
                commentsList.appendChild(commentEl);
            });
        }

        async function showDiaryDetail(diary) {
            currentDiary = diary; 
            const detailContainer = document.getElementById('detail-content-container');
            detailContainer.innerHTML = ''; 

            const authorAvatar = document.getElementById('detail-author-avatar');
            const headerTextElement = document.getElementById('detail-header-text');
            let mainTitleText = '';
            const title = diary.title || '';
            const parts = title.split(/[:ï¼š]/);

            if (parts.length > 1) {
                const headerText = parts[0].trim();
                mainTitleText = parts.slice(1).join(':').trim();
                authorAvatar.style.display = 'none';
                headerTextElement.textContent = headerText;
            } else {
                const authorProfile = await getAuthorProfile(diary.authorId);
                authorAvatar.style.display = 'block';
                if (authorProfile) {
                    const name = authorProfile.displayName || 'ä½œè€…';
                    authorAvatar.src = `https://placehold.co/100x100/fde68a/a16207?text=${name.charAt(0).toUpperCase()}`;
                    headerTextElement.textContent = name;
                } else {
                    authorAvatar.src = 'https://placehold.co/100x100/e2e8f0/475569?text=?';
                    headerTextElement.textContent = 'åŒ¿åä½œè€…';
                }
                mainTitleText = title;
            }
            
            const date = diary.createdAt ? diary.createdAt.toDate().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' }) : '';

            let eventsArray = diary.events;
            if (typeof eventsArray === 'string') {
                try { eventsArray = JSON.parse(eventsArray); } catch (e) { eventsArray = []; }
            }
            
            const user = auth.currentUser;
            const likes = diary.likes || [];
            const isLiked = user ? likes.includes(user.uid) : false;
            let selectedCommentPhoto = null;

            const contentHTML = `
                <div class="p-5">
                    <p class="text-lg text-gray-500 mb-2">${date}</p>
                    <h1 class="text-3xl font-bold text-gray-900 mb-8">${mainTitleText}</h1>
                     <div class="summary-note">
                         <p class="text-2xl text-gray-700 leading-relaxed">${diary.overall_story || ''}</p>
                     </div>
                    <hr class="my-8 border-gray-200">
                </div>
                <div class="relative px-5 py-2">${(diary.photoURLs || []).map((imageUrl, index) => {
                    const event = eventsArray[index] || {};
                    return `
                        <div class="timeline-item">
                             <div class="timeline-dot"></div>
                             <div class="w-full bg-black rounded-lg overflow-hidden mb-4 shadow-lg">
                                <img src="${imageUrl}" alt="äº‹ä»¶ç…§ç‰‡ ${index + 1}" class="w-full h-auto object-contain block" style="max-height: 70vh;">
                             </div>
                            <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-2 mb-3 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="col-start-1 row-start-1 h-5 w-5 text-sky-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="col-start-2 row-start-1 text-gray-600">${event.time || 'æœªçŸ¥æ™‚é–“'}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="col-start-1 row-start-2 h-5 w-5 text-rose-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span class="col-start-2 row-start-2 text-gray-600">${event.location || 'æœªçŸ¥åœ°é»'}</span>
                            </div>
                            <p class="text-base text-gray-700 leading-relaxed">${event.description || ''}</p>
                        </div>
                    `;
                }).join('')}</div>
                
                <div class="p-5 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <button class="like-button flex items-center space-x-2 text-gray-600 hover:text-red-500 transition-colors ${isLiked ? 'liked' : ''}">
                           <svg class="heart-icon w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                            <span id="like-count" class="font-semibold">${likes.length}</span>
                        </button>
                    </div>
                    <div class="mt-6">
                         <h3 class="font-bold text-gray-800 mb-3">ç•™è¨€</h3>
                         <div id="comments-list" class="space-y-4"></div>
                         <form id="comment-form" class="mt-4">
                            <div id="comment-photo-preview-container" class="hidden mb-2 relative w-24 h-24">
                                <img id="comment-photo-preview" class="w-full h-full object-cover rounded-lg">
                                <button id="remove-comment-photo" type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center font-bold">&times;</button>
                            </div>
                             <div class="flex items-start space-x-2">
                                 <label for="comment-photo-upload" class="cursor-pointer p-2 text-gray-500 hover:text-amber-500">
                                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                 </label>
                                 <input type="file" id="comment-photo-upload" class="hidden" accept="image/*">
                                 <textarea id="comment-input" class="w-full p-2 border rounded-lg bg-gray-50 text-sm" rows="1" placeholder="æ–°å¢ç•™è¨€..."></textarea>
                                 <button type="submit" class="bg-amber-500 text-white font-semibold px-4 py-2 rounded-lg">é€å‡º</button>
                             </div>
                         </form>
                    </div>
                </div>
            `;
            detailContainer.innerHTML = contentHTML;

            const likeButton = detailContainer.querySelector('.like-button');
            if(likeButton) {
                likeButton.addEventListener('click', async () => {
                    if (!user || user.isAnonymous) {
                         guestModal.classList.add('visible');
                         return;
                    }
                    const diaryRef = doc(db, "diaries", diary.id);
                    const newLikedState = !likeButton.classList.contains('liked');
                    await updateDoc(diaryRef, {
                        likes: newLikedState ? arrayUnion(user.uid) : arrayRemove(user.uid)
                    });
                });
            }
            
            const commentPhotoUpload = detailContainer.querySelector('#comment-photo-upload');
            const commentPhotoPreviewContainer = detailContainer.querySelector('#comment-photo-preview-container');
            const commentPhotoPreview = detailContainer.querySelector('#comment-photo-preview');
            const removeCommentPhoto = detailContainer.querySelector('#remove-comment-photo');

            commentPhotoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedCommentPhoto = file;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        commentPhotoPreview.src = event.target.result;
                        commentPhotoPreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeCommentPhoto.addEventListener('click', () => {
                selectedCommentPhoto = null;
                commentPhotoUpload.value = '';
                commentPhotoPreviewContainer.classList.add('hidden');
            });


            const commentForm = detailContainer.querySelector('#comment-form');
            if(commentForm) {
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!user || user.isAnonymous) {
                        guestModal.classList.add('visible');
                        return;
                    }
                    const commentInput = document.getElementById('comment-input');
                    const text = commentInput.value.trim();
                    
                    if (!text && !selectedCommentPhoto) return;

                    let imageUrl = null;
                    if (selectedCommentPhoto) {
                        const filePath = `comments/${user.uid}/${Date.now()}-${selectedCommentPhoto.name}`;
                        const storageRef = ref(storage, filePath);
                        const snapshot = await uploadBytes(storageRef, selectedCommentPhoto);
                        imageUrl = await getDownloadURL(snapshot.ref);
                    }

                    await addDoc(collection(db, "diaries", diary.id, "comments"), {
                        text: text,
                        authorId: user.uid,
                        authorName: currentUserProfile ? currentUserProfile.displayName : "è¨ªå®¢",
                        createdAt: serverTimestamp(),
                        imageUrl: imageUrl
                    });
                    
                    commentInput.value = '';
                    selectedCommentPhoto = null;
                    commentPhotoUpload.value = '';
                    commentPhotoPreviewContainer.classList.add('hidden');
                });
            }

            if (commentsUnsubscribe) commentsUnsubscribe();
            const commentsQuery = query(collection(db, "diaries", diary.id, "comments"), orderBy("createdAt", "asc"));
            commentsUnsubscribe = onSnapshot(commentsQuery, (snapshot) => {
                const comments = [];
                snapshot.forEach(doc => comments.push(doc.data()));
                renderComments(comments);
            });

            navigateTo('detail-screen');
        }


        function renderDiaries(diaries) {
            diariesContainer.innerHTML = ''; 
            
            if (diaries.length === 0) {
                diariesContainer.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-gray-500">é‚„æ²’æœ‰ä»»ä½•æ—¥è¨˜å–”ï¼</p>
                        <button id="create-first-diary-button" class="mt-4 bg-amber-500 text-white font-bold py-2 px-4 rounded-lg">
                            å»ºç«‹ç¬¬ä¸€ç¯‡å›æ†¶
                        </button>
                    </div>
                `;
                document.getElementById('create-first-diary-button').addEventListener('click', () => navigateTo('create-screen'));
                return;
            }

            diaries.forEach(diary => {
                const date = diary.createdAt ? diary.createdAt.toDate().toLocaleDateString('zh-TW') : 'æœªçŸ¥æ—¥æœŸ';
                const privacyIcon = diary.privacy === 'private' ? 'ğŸ”’' : diary.privacy === 'group' ? 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' : 'ğŸŒ';
                const coverImage = (diary.photoURLs && diary.photoURLs.length > 0) 
                    ? diary.photoURLs[diary.coverPhotoIndex || 0] 
                    : `https://placehold.co/600x400/34D399/FFFFFF?text=${encodeURIComponent(diary.title)}`;
                
                let location = '';
                if (diary.events) {
                    try {
                        const eventsArray = JSON.parse(diary.events);
                        if (eventsArray.length > 0 && eventsArray[0].location) {
                            location = eventsArray[0].location;
                        }
                    } catch(e) { /* Do nothing */ }
                }

                const diaryCard = document.createElement('div');
                diaryCard.className = 'memory-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition-shadow duration-300';
                diaryCard.innerHTML = `
                    <img src="${coverImage}" alt="${diary.title}" class="w-full h-40 object-cover">
                    <div class="p-4 relative">
                        <h2 class="text-lg font-bold text-gray-800 truncate">${diary.title}</h2>
                        <div class="flex items-center justify-between mt-2">
                            <p class="text-sm text-amber-700 font-medium">${date}</p>
                            ${location ? `
                            <div class="flex items-center space-x-1 text-xs bg-sky-100 text-sky-800 px-2 py-1 rounded-full font-semibold">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span>${location}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="absolute top-2 right-2 text-gray-400" title="${diary.privacy}">${privacyIcon}</div>
                    </div>
                `;
                diaryCard.addEventListener('click', () => showDiaryDetail(diary));
                diariesContainer.appendChild(diaryCard);
            });
        }
        
        function updateUserInfo(user, profileData) {
            const hour = new Date().getHours();
            let greetingText = "æ‚¨å¥½ï¼";
            if (hour < 12) {
                greetingText = "æ—©å®‰ï¼";
            } else if (hour < 18) {
                greetingText = "ä¸‹åˆå¥½ï¼";
            } else {
                greetingText = "æ™šå®‰ï¼";
            }

            const settingsAvatar = document.getElementById('settings-avatar');
            const settingsDisplayName = document.getElementById('settings-display-name');
            const settingsUsername = document.getElementById('settings-username');

            if (user.isAnonymous) {
                greeting.textContent = `${greetingText}è¨ªå®¢ï¼`;
                settingsAvatar.src = `https://placehold.co/100x100/e2e8f0/475569?text=?`;
                settingsDisplayName.textContent = 'è¨ªå®¢';
                settingsUsername.textContent = '@guest';
            } else {
                const displayName = profileData ? profileData.displayName : user.email.split('@')[0];
                const username = profileData ? profileData.username : `@${user.email.split('@')[0]}`;
                
                greeting.textContent = `${greetingText}${displayName}ï¼`;
                settingsAvatar.src = `https://placehold.co/100x100/fde68a/a16207?text=${displayName.charAt(0).toUpperCase()}`;
                settingsDisplayName.textContent = displayName;
                settingsUsername.textContent = username;
            }
        }


        onAuthStateChanged(auth, async (user) => {
            if (diariesUnsubscribe) diariesUnsubscribe();
            if (userProfileUnsubscribe) userProfileUnsubscribe();

            if (user) {
                console.log("User is signed in:", user.uid);
                
                const userDocRef = doc(db, "users", user.uid);
                if (!user.isAnonymous) {
                    const docSnap = await getDoc(userDocRef);
                    if (!docSnap.exists()) {
                        const name = user.email.split('@')[0];
                        await setDoc(userDocRef, {
                            displayName: name,
                            username: `@${name.toLowerCase()}`,
                            email: user.email,
                            bio: "ç†±æ„›ç”¨ç…§ç‰‡è¨˜éŒ„å®¶åº­ç”Ÿæ´»çš„é»é»æ»´æ»´ã€‚"
                        });
                    }
                }
                
                userProfileUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserProfile = docSnap.data();
                        updateUserInfo(user, currentUserProfile);
                    } else {
                        updateUserInfo(user, null);
                    }
                });

                const q = query(collection(db, "diaries"), where("authorId", "==", user.uid));
                
                diariesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    const diaries = [];
                    querySnapshot.forEach((doc) => {
                        diaries.push({ id: doc.id, ...doc.data() });
                    });
                    
                    diaries.sort((a, b) => {
                        const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                        const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                        return timeB - timeA;
                    });

                    renderDiaries(diaries);
                    
                    if (currentDiary && document.getElementById('detail-screen').classList.contains('is-active')) {
                        const updatedDiary = diaries.find(d => d.id === currentDiary.id);
                        if (updatedDiary) {
                            showDiaryDetail(updatedDiary);
                        }
                    }

                }, (error) => {
                    console.error("Error getting diaries: ", error);
                    diariesContainer.innerHTML = `
                        <div class="p-4 text-center">
                            <p class="font-bold text-red-600">è®€å–æ—¥è¨˜å¤±æ•—</p>
                            <p class="text-sm text-gray-600 mt-2">æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•è®€å–è³‡æ–™åº«ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firestore å®‰å…¨æ€§è¦å‰‡ã€‚</p>
                        </div>
                    `;
                });

                if(navigationStack[0] === 'auth-screen') {
                    navigationStack = ['home-screen'];
                    navigateTo('home-screen');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    document.querySelector('.bottom-nav-item[data-target="home-screen"]').classList.add('active');
                }

            } else {
                console.log("User is signed out.");
                renderDiaries([]);
                navigationStack = ['auth-screen'];
                navigateTo('auth-screen');
                currentUserProfile = null;
            }
        });

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const guestButton = document.getElementById('guest-button');
        const logoutButton = document.getElementById('logout-button');

        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<div class="spinner"></div>';
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText;
            }
        }
        
        loginButton.dataset.originalText = loginButton.innerHTML;
        registerButton.dataset.originalText = registerButton.innerHTML;
        
        loginButton.addEventListener('click', async () => {
            setButtonLoading(loginButton, true);
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                authError.textContent = "ç™»å…¥å¤±æ•—ï¼š" + error.message;
            } finally {
                setButtonLoading(loginButton, false);
            }
        });

        registerButton.addEventListener('click', async () => {
            setButtonLoading(registerButton, true);
            authError.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                const user = userCredential.user;
                
                // Create a user profile document
                const userDocRef = doc(db, "users", user.uid);
                const name = user.email.split('@')[0];
                await setDoc(userDocRef, {
                    displayName: name,
                    username: `@${name.toLowerCase()}`,
                    email: user.email,
                    bio: "ç†±æ„›ç”¨ç…§ç‰‡è¨˜éŒ„å®¶åº­ç”Ÿæ´»çš„é»é»æ»´æ»´ã€‚"
                });

            } catch (error) {
                authError.textContent = "è¨»å†Šå¤±æ•—ï¼š" + error.message;
            } finally {
                setButtonLoading(registerButton, false);
            }
        });
        
        guestButton.addEventListener('click', async () => {
             try {
                await signInAnonymously(auth);
            } catch (error) {
                authError.textContent = "è¨ªå®¢ç™»å…¥å¤±æ•—ï¼š" + error.message;
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.dataset.target;
                navigationStack = [targetId];
                navigateTo(targetId);
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
            });
        });

        document.getElementById('fab-nav').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user && user.isAnonymous) {
                guestModal.classList.add('visible');
            } else if (user) {
                navigateTo('create-screen');
            } else {
                navigateTo('auth-screen');
            }
        });
        
        document.querySelectorAll('#explore-screen .masonry-item, #profile-screen .masonry-item').forEach(card => card.addEventListener('click', () => navigateTo('detail-screen')));
        document.querySelectorAll('#explore-screen .creator-card').forEach(card => card.addEventListener('click', () => navigateTo('profile-screen')));
        
        document.querySelectorAll('.go-back-button').forEach(button => button.addEventListener('click', goBack));
        
        document.getElementById('go-to-earnings').addEventListener('click', () => navigateTo('earnings-screen'));
        document.getElementById('go-to-groups').addEventListener('click', () => navigateTo('groups-screen'));
        document.querySelectorAll('#groups-screen .group-item').forEach(item => item.addEventListener('click', () => navigateTo('group-edit-screen')));
        document.getElementById('create-group-button').addEventListener('click', () => navigateTo('group-create-screen'));
        
        document.getElementById('go-to-profile-edit').addEventListener('click', () => {
            if (currentUserProfile) {
                document.getElementById('profile-edit-username').value = currentUserProfile.username || '';
                document.getElementById('profile-edit-display-name').value = currentUserProfile.displayName || '';
                document.getElementById('profile-edit-bio').value = currentUserProfile.bio || '';
                document.getElementById('profile-edit-email').value = currentUserProfile.email || '';
                document.getElementById('profile-edit-avatar').src = `https://placehold.co/100x100/fde68a/a16207?text=${currentUserProfile.displayName.charAt(0).toUpperCase()}`;
            }
            navigateTo('profile-edit-screen');
        });

        document.getElementById('save-profile-button').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            const newDisplayName = document.getElementById('profile-edit-display-name').value;
            const newBio = document.getElementById('profile-edit-bio').value;

            const userDocRef = doc(db, "users", user.uid);
            try {
                await updateDoc(userDocRef, {
                    displayName: newDisplayName,
                    bio: newBio
                });
                goBack();
            } catch (error) {
                console.error("Error updating profile: ", error);
                showToast("æ›´æ–°å€‹äººè³‡æ–™å¤±æ•—ï¼", "error");
            }
        });
        
        document.getElementById('go-to-writing-style').addEventListener('click', () => navigateTo('writing-style-screen'));

        // --- Create Diary Page ---
        const generateDiaryButton = document.getElementById('generate-diary-button');
        const photoUpload = document.getElementById('photo-upload');
        const photoGridContainer = document.getElementById('photo-grid-container');
        const photoCountSpan = document.getElementById('photo-count');

        function renderPhotoPreviews() {
            photoGridContainer.innerHTML = ''; 

            selectedFiles.forEach((file, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative aspect-square cursor-pointer';
                wrapper.dataset.index = index;

                const img = document.createElement('img');
                img.className = "rounded-lg w-full h-full object-cover";
                if (index === selectedCoverIndex) {
                    img.classList.add('cover-photo');
                }

                const removeBtn = document.createElement('button');
                removeBtn.className = 'absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold leading-none hover:bg-red-600 transition-colors z-10';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = "ç§»é™¤é€™å¼µç…§ç‰‡";
                
                const orderBadge = document.createElement('div');
                orderBadge.className = 'absolute top-2 left-2 w-6 h-6 bg-black/50 text-white rounded-full flex items-center justify-center text-xs font-bold z-10';
                orderBadge.textContent = index + 1;
                orderBadge.title = "ç…§ç‰‡é †åº";


                removeBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const indexToRemove = parseInt(wrapper.dataset.index, 10);
                    selectedFiles.splice(indexToRemove, 1);
                    if (selectedCoverIndex === indexToRemove) {
                        selectedCoverIndex = 0;
                    } else if (selectedCoverIndex > indexToRemove) {
                        selectedCoverIndex--;
                    }
                    renderPhotoPreviews();
                });

                wrapper.addEventListener('click', () => {
                    selectedCoverIndex = parseInt(wrapper.dataset.index, 10);
                    renderPhotoPreviews();
                });

                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                wrapper.appendChild(orderBadge);
                photoGridContainer.appendChild(wrapper);

                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            });

            const addPhotoLabel = document.createElement('label');
            addPhotoLabel.htmlFor = 'photo-upload';
            addPhotoLabel.className = "aspect-square bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors";
            addPhotoLabel.innerHTML = `
                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span class="mt-2 text-sm text-gray-500">æ–°å¢ç…§ç‰‡</span>
            `;
            photoGridContainer.appendChild(addPhotoLabel);

            photoCountSpan.textContent = `å·²é¸å–çš„ç…§ç‰‡ (${selectedFiles.length})`;
            if (generateDiaryButton) {
                generateDiaryButton.disabled = selectedFiles.length === 0;
            }
        }

        if(photoUpload) {
            photoUpload.addEventListener('change', (event) => {
                const newFiles = Array.from(event.target.files);
                
                newFiles.forEach(newFile => {
                    // Check for duplicates based on name, size, and last modified date
                    const isDuplicate = selectedFiles.some(existingFile => 
                        existingFile.name === newFile.name &&
                        existingFile.size === newFile.size &&
                        existingFile.lastModified === newFile.lastModified
                    );

                    if (!isDuplicate) {
                        selectedFiles.push(newFile);
                    }
                });

                renderPhotoPreviews();
                event.target.value = ''; // Clear the input to allow selecting the same file again after removing it
            });
        }
        
        function resetCreateForm() {
            photoUpload.value = '';
            selectedFiles = [];
            selectedCoverIndex = 0;
            renderPhotoPreviews();
        }

        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }
        
        generateDiaryButton.dataset.originalText = generateDiaryButton.innerHTML;
        generateDiaryButton.addEventListener('click', async (e) => {
            e.preventDefault();
            setButtonLoading(generateDiaryButton, true);
            createError.textContent = '';
            
            const user = auth.currentUser;
            if (!user) {
                createError.textContent = "éŒ¯èª¤ï¼šæ‚¨å°šæœªç™»å…¥ã€‚";
                setButtonLoading(generateDiaryButton, false);
                return;
            }

            const privacy = document.getElementById('privacy-select').value;
            const styleElement = document.querySelector('input[name="writing-style"]:checked');
            const styleValue = styleElement ? styleElement.value : 'warm';
            
            const styleMapping = {
                warm: 'æº«é¦¨æ„Ÿæ€§é¢¨',
                fun: 'æ´»æ½‘æœ‰è¶£é¢¨',
                simple: 'ç°¡æ½”ç´€éŒ„é¢¨'
            };
            const styleText = styleMapping[styleValue] || 'æº«é¦¨æ„Ÿæ€§é¢¨';
            
            try {
                const uploadedPhotoURLs = [];
                if (selectedFiles.length > 0) {
                    const uploadPromises = selectedFiles.map(async (file) => {
                        const options = {
                            maxSizeMB: 1,
                            maxWidthOrHeight: 1920,
                            useWebWorker: true
                        }
                        const compressedFile = await imageCompression(file, options);
                        const filePath = `diaries/${user.uid}/${Date.now()}-${compressedFile.name}`;
                        const storageRef = ref(storage, filePath);
                        const snapshot = await uploadBytes(storageRef, compressedFile);
                        return await getDownloadURL(snapshot.ref);
                    });
                    uploadedPhotoURLs.push(...await Promise.all(uploadPromises));
                }

                const textPrompt = `è«‹æ ¹æ“šæˆ‘æä¾›çš„ ${selectedFiles.length} å¼µç…§ç‰‡ï¼Œç”¨${styleText}é¢¨æ ¼ï¼Œç”Ÿæˆä¸€å€‹JSONç‰©ä»¶ã€‚ç‰©ä»¶éœ€åŒ…å«ï¼š
1. "title": ç¬¦åˆé¢¨æ ¼çš„æ•…äº‹æ¨™é¡Œï¼Œé•·åº¦è«‹å‹¿è¶…é14å€‹å­—ã€‚
2. "overall_story": å°‡æ‰€æœ‰ç…§ç‰‡ä¸²é€£èµ·ä¾†çš„ç¸½çµæ€§æ•…äº‹ï¼Œé•·åº¦è«‹å‹¿è¶…é100å€‹å­—ã€‚
3. "events": ä¸€å€‹é™£åˆ—ï¼Œé™£åˆ—ä¸­æ¯å€‹ç‰©ä»¶ä»£è¡¨ä¸€å¼µç…§ç‰‡ï¼ŒåŒ…å« "time" (ç…§ç‰‡çš„æ™‚é–“ï¼Œå¦‚æœæœªçŸ¥è«‹æ¨æ¸¬ï¼Œæ ¼å¼ç‚º 'ä¸‹åˆ 03:15')ã€ "location" (ç…§ç‰‡çš„åœ°é»ï¼Œå¦‚æœæœªçŸ¥è«‹æ¨æ¸¬å…·é«”åç¨±ï¼Œä¾‹å¦‚ 'é«˜é›„å¸‚ï¼Œé§äºŒè—è¡“ç‰¹å€')ã€ "description" (ç…§ç‰‡çš„äº‹ä»¶æè¿°ï¼Œ100å­—å…§)ã€‚
4. "cover_photo_index": ä¸€å€‹æ•¸å­—ï¼Œä»£è¡¨ä½ èªç‚ºæœ€é©åˆç•¶å°é¢çš„ç…§ç‰‡ç´¢å¼•ï¼ˆå¾0é–‹å§‹ï¼‰ã€‚`;
                
                const imageParts = await Promise.all(selectedFiles.map(fileToGenerativePart));
                
                const payload = {
                    contents: [{ parts: [{ text: textPrompt }, ...imageParts] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "overall_story": { "type": "STRING" },
                                "events": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "time": { "type": "STRING" },
                                            "location": { "type": "STRING" },
                                            "description": { "type": "STRING" }
                                        },
                                        "required": ["time", "location", "description"]
                                    }
                                },
                                "cover_photo_index": { "type": "NUMBER" }
                            },
                            required: ["title", "overall_story", "events", "cover_photo_index"]
                        }
                    }
                };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                     throw new Error("Invalid API response structure.");
                }
                const generatedData = JSON.parse(result.candidates[0].content.parts[0].text);
                
                const finalCoverIndex = selectedCoverIndex || generatedData.cover_photo_index || 0;

                const diaryData = {
                    title: generatedData.title,
                    overall_story: generatedData.overall_story,
                    events: JSON.stringify(generatedData.events),
                    privacy: privacy,
                    authorId: user.uid,
                    createdAt: serverTimestamp(),
                    photoURLs: uploadedPhotoURLs,
                    likes: [],
                    style: styleValue,
                    coverPhotoIndex: finalCoverIndex
                };
                
                const docRef = await addDoc(collection(db, "diaries"), diaryData);
                console.log("æ—¥è¨˜å·²å„²å­˜ï¼ŒID: ", docRef.id);
                
                resetCreateForm();
                navigationStack = ['home-screen']; 
                navigateTo('home-screen');

            } catch (error) {
                console.error("å„²å­˜æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
                createError.textContent = "æ—¥è¨˜ç”Ÿæˆæˆ–å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            } finally {
                setButtonLoading(generateDiaryButton, false);
            }
        });
        
        const editButton = document.getElementById('edit-button');
        if(editButton) {
            editButton.addEventListener('click', () => {
                if (!currentDiary) return;
                
                let eventsArray = currentDiary.events;
                if (typeof eventsArray === 'string') {
                    try {
                        eventsArray = JSON.parse(eventsArray);
                    } catch (e) {
                        eventsArray = [];
                    }
                }

                if (!Array.isArray(eventsArray)) {
                    showToast("æ­¤æ—¥è¨˜æ ¼å¼ä¸æ”¯æ´ç·¨è¼¯ã€‚", "error");
                    return;
                }

                document.getElementById('edit-title').value = currentDiary.title || '';
                document.getElementById('edit-overall-story').value = currentDiary.overall_story || '';
                
                const eventsContainer = document.getElementById('edit-events-container');
                eventsContainer.innerHTML = ''; // Clear previous
                
                eventsArray.forEach((event, index) => {
                    const eventEditorHTML = `
                        <div>
                            <label class="text-base font-semibold text-gray-600">äº‹ä»¶ ${index + 1} æè¿°</label>
                            <textarea data-event-index="${index}" class="edit-event-description w-full mt-1 p-2 border border-gray-300 rounded-lg h-20">${event.description || ''}</textarea>
                        </div>
                    `;
                    eventsContainer.insertAdjacentHTML('beforeend', eventEditorHTML);
                });

                navigateTo('edit-screen');
            });
        }

        const saveButton = document.getElementById('save-button');
        if(saveButton) {
            saveButton.addEventListener('click', async () => {
                if (!currentDiary || !currentDiary.id) {
                    showToast("æ‰¾ä¸åˆ°è¦å„²å­˜çš„æ—¥è¨˜ï¼", "error");
                    return;
                }

                const newTitle = document.getElementById('edit-title').value;
                const newOverallStory = document.getElementById('edit-overall-story').value;
                const descriptionElements = document.querySelectorAll('.edit-event-description');
                
                let currentEvents = currentDiary.events;
                 if (typeof currentEvents === 'string') {
                     try {
                        currentEvents = JSON.parse(currentEvents);
                     } catch(e) {
                         currentEvents = [];
                     }
                }

                const newEvents = Array.from(descriptionElements).map((textarea, index) => {
                    return {
                        ...currentEvents[index], // Preserve time and location
                        description: textarea.value
                    };
                });

                const updatedData = {
                    title: newTitle,
                    overall_story: newOverallStory,
                    events: JSON.stringify(newEvents)
                };

                try {
                    const diaryRef = doc(db, "diaries", currentDiary.id);
                    await updateDoc(diaryRef, updatedData);
                    
                    currentDiary = { ...currentDiary, ...updatedData };
                    goBack(); 
                    showDiaryDetail(currentDiary); 

                } catch (error) {
                    console.error("æ›´æ–°æ—¥è¨˜å¤±æ•—:", error);
                    showToast("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "error");
                }
            });
        }

        const shareButton = document.getElementById('share-button');
        const modalContainer = document.getElementById('share-modal-container');
        if (shareButton) {
            shareButton.addEventListener('click', () => modalContainer.classList.add('visible'));
            document.getElementById('close-modal-button').addEventListener('click', () => modalContainer.classList.remove('visible'));
            document.getElementById('done-button').addEventListener('click', () => modalContainer.classList.remove('visible'));
            document.getElementById('share-modal-backdrop').addEventListener('click', () => modalContainer.classList.remove('visible'));
            
            document.querySelectorAll('.share-group-button').forEach(button => {
                button.addEventListener('click', () => {
                    const groupName = button.querySelector('span:last-child').textContent;
                    showToast(`å·²åˆ†äº«çµ¦ ${groupName}ï¼`);
                    modalContainer.classList.remove('visible');
                });
            });

            const copyButton = document.getElementById('copy-link-button');
            copyButton.addEventListener('click', () => {
                const linkInput = copyButton.previousElementSibling;
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showToast('é€£çµå·²è¤‡è£½ï¼');
                });
            });
        }
        
        const addMemberButton = document.getElementById('add-member-button');
        const addMemberModalContainer = document.getElementById('add-member-modal-container');
        const inviteLinkDetails = document.getElementById('invite-link-details');

        if (addMemberButton) {
            addMemberButton.addEventListener('click', () => {
                inviteLinkDetails.classList.add('hidden');
                addMemberModalContainer.classList.add('visible');
            });
        }

        const closeAddMemberModalButton = document.getElementById('close-add-member-modal-button');
        const addMemberModalBackdrop = document.getElementById('add-member-modal-backdrop');

        function closeAddMemberModal() {
            if(addMemberModalContainer) addMemberModalContainer.classList.remove('visible');
        }

        if(closeAddMemberModalButton) closeAddMemberModalButton.addEventListener('click', closeAddMemberModal);
        if(addMemberModalBackdrop) addMemberModalBackdrop.addEventListener('click', closeAddMemberModal);

        document.querySelectorAll('.invite-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.target.textContent = 'å·²é‚€è«‹';
                e.target.disabled = true;
                e.target.classList.remove('bg-blue-500');
                e.target.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
                showToast('å·²é€å‡ºé‚€è«‹ï¼');
            });
        });
        
        const generateInviteLinkButton = document.getElementById('generate-invite-link');
        if(generateInviteLinkButton) {
            generateInviteLinkButton.addEventListener('click', () => {
                inviteLinkDetails.classList.toggle('hidden');
            });
        }
        
        const copyInviteLinkButton = document.getElementById('copy-invite-link-button');
        if(copyInviteLinkButton) {
             copyInviteLinkButton.addEventListener('click', () => {
                const linkInput = copyInviteLinkButton.previousElementSibling;
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showToast('é‚€è«‹é€£çµå·²è¤‡è£½ï¼');
                });
            });
        }

        const emojiPickerButton = document.getElementById('emoji-picker-button');
        if (emojiPickerButton) {
            const emojis = ['ğŸ½ï¸', 'ğŸ•ï¸', 'ğŸ‚', 'ğŸ–ï¸', 'âœˆï¸', 'ğŸ‰', 'ğŸ '];
            let currentIndex = 0;
            emojiPickerButton.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % emojis.length;
                emojiPickerButton.textContent = emojis[currentIndex];
            });
        }

        const customPromptTextarea = document.getElementById('custom-prompt-style');
        if(customPromptTextarea) {
            document.querySelectorAll('input[name="writing-style-option"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'custom') {
                        customPromptTextarea.disabled = false;
                        customPromptTextarea.classList.remove('bg-gray-50');
                    } else {
                        customPromptTextarea.disabled = true;
                        customPromptTextarea.classList.add('bg-gray-50');
                    }
                });
            });
        }

        const exploreTabs = document.querySelectorAll('.explore-tab');
        const tabContents = document.querySelectorAll('#explore-screen .tab-content');

        exploreTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                exploreTabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.add('hidden'));

                tab.classList.add('active');
                const contentId = tab.dataset.tab + '-content';
                document.getElementById(contentId).classList.remove('hidden');
            });
        });

        document.getElementById('close-guest-modal-button').addEventListener('click', () => {
            guestModal.classList.remove('visible');
        });
        document.getElementById('go-to-auth-button').addEventListener('click', async () => {
            guestModal.classList.remove('visible');
            await signOut(auth);
            navigateTo('auth-screen');
        });

        document.querySelectorAll('.adventure-card').forEach(card => {
            card.addEventListener('click', () => {
                navigateTo('adventure-detail-screen');
            });
        });

        const toastElement = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        let toastTimeout;

        function showToast(message, type = 'success') {
            clearTimeout(toastTimeout);

            toastMessage.textContent = message;

            toastElement.classList.remove('bg-green-500', 'bg-red-500', 'show');

            if (type === 'success') {
                toastElement.classList.add('bg-green-500');
            } else if (type === 'error') {
                toastElement.classList.add('bg-red-500');
            }

            toastElement.classList.add('show');

            toastTimeout = setTimeout(() => {
                toastElement.classList.remove('show');
            }, 3000);
        }
        
    </script>
</body>
</html>
