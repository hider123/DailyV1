<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家庭時光膠囊 - 互動原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <!-- Image Compression Library -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <!-- EXIF Data Reader Library -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .mobile-screen {
            width: 100%;
            max-width: 414px;
            height: 800px;
            border: 8px solid #1a202c;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            position: relative;
            background-color: #f8fafc;
        }
        .page-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        /* --- Animation Keyframes --- */
        @keyframes heart-bounce {
            0%, 100% { transform: scale(1); }
            30% { transform: scale(1.3); }
            60% { transform: scale(0.9); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Page Transition --- */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            background-color: inherit;
        }
        .page.is-active {
           opacity: 1;
           pointer-events: auto;
           transform: scale(1);
        }

        .modal-container {
            visibility: hidden; opacity: 0;
            transition: visibility 0s 0.3s, opacity 0.3s linear;
        }
        .modal-container.visible {
            visibility: visible; opacity: 1;
            transition: opacity 0.3s linear;
        }
        #share-modal-panel, #add-member-modal-panel {
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
        }
        #share-modal-container.visible #share-modal-panel,
        #add-member-modal-container.visible #add-member-modal-panel {
            transform: translateY(0);
        }
        .photo-carousel::-webkit-scrollbar, .tag-carousel::-webkit-scrollbar, .featured-carousel::-webkit-scrollbar { display: none; }
        .masonry {
            column-count: 2;
            column-gap: 1rem;
            column-fill: balance;
        }
        @media (max-width: 360px) {
            .masonry { column-count: 1; }
        }
        .masonry-item {
            display: inline-block;
            width: 100%;
            margin-bottom: 1rem;
            break-inside: avoid;
        }
        .masonry-item img { width: 100%; height: auto; display: block; }
        .bottom-nav-item.active svg,
        .bottom-nav-item.active p {
            color: #f59e0b; /* amber-500 */
        }
        .like-button .heart-icon {
            fill: none;
            stroke: currentColor;
            transition: all 0.2s ease-in-out;
        }
        .like-button.liked .heart-icon {
            fill: #ef4444; /* red-500 */
            stroke: #ef4444;
            animation: heart-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .explore-tab.active {
            border-bottom-color: #f59e0b;
            color: #0f172a;
        }
        .tab-content.hidden {
            display: none;
        }
        
        /* --- Tab Content Animation --- */
        .tab-content {
            animation: fadeIn 0.4s ease-out;
        }

        .map-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #ef4444;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            border: 2px solid white;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .map-pin::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .spinner-small {
            border: 2px solid rgba(128, 128, 128, 0.3);
            border-top-color: #666;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* --- Timeline Styles --- */
        .timeline-item {
            position: relative;
            padding-left: 30px; 
            padding-bottom: 2rem;
        }
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 8px;
            bottom: -8px; 
            width: 2px;
            background-color: #e2e8f0; /* gray-200 */
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: 8px;
            top: 8px;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background-color: #f59e0b; /* amber-500 */
            border: 3px solid white;
            border-radius: 50%;
            z-index: 1;
        }
        .cover-photo {
            border: 4px solid #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .summary-note {
            font-family: 'Zhi Mang Xing', cursive;
            background-color: #fffbeb; /* amber-50 */
            border: 1px solid #fde68a; /* amber-200 */
            padding: 1.5rem;
            padding-top: 2rem;
            border-radius: 4px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.15);
            position: relative;
            transform: rotate(-1.5deg);
            margin: 1.5rem 0.5rem;
        }
        .summary-note::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background-color: #ef4444; /* red-500 */
            border-radius: 50%;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        /* --- Toast Notification --- */
        #toast-notification.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="mobile-screen">
        <!-- Toast Notification -->
        <div id="toast-notification" class="absolute top-0 left-1/2 -translate-x-1/2 mt-12 px-6 py-3 rounded-full shadow-lg text-white font-semibold text-sm z-50 transition-all duration-300 ease-in-out transform -translate-y-20 opacity-0">
            <p id="toast-message"></p>
        </div>

        <div class="page-container">

            <!-- ================================================== -->
            <!-- =====      登入/註冊頁 (Auth)          ===== -->
            <!-- ================================================== -->
            <div id="auth-screen" class="page is-active">
                <div class="flex flex-col justify-center items-center h-full p-8 bg-amber-50">
                    <h1 class="text-4xl font-bold text-amber-800 mb-2">家庭時光膠囊</h1>
                    <p class="text-amber-700 mb-10">珍藏您的家庭回憶</p>
                    
                    <div class="w-full max-w-sm">
                        <div class="mb-4">
                            <label for="email" class="block text-amber-800 text-sm font-bold mb-2">電子郵件</label>
                            <input type="email" id="email" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-amber-400" placeholder="you@example.com">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-amber-800 text-sm font-bold mb-2">密碼</label>
                            <input type="password" id="password" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-amber-400" placeholder="******************">
                        </div>
                        <div id="auth-error" class="text-red-500 text-xs italic mb-4 h-4"></div>
                        <div class="flex flex-col space-y-3">
                            <button id="login-button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors flex items-center justify-center">登入</button>
                            <button id="register-button" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors flex items-center justify-center">註冊新帳號</button>
                            <button id="guest-button" class="text-amber-700 hover:text-amber-900 text-sm font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">訪客瀏覽</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ================================================== -->
            <!-- =====        主畫面 (Home)             ===== -->
            <!-- ================================================== -->
            <div id="home-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <div><h1 id="greeting" class="text-xl font-bold text-gray-800">您好！</h1></div>
                    </div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main id="diaries-container" class="p-4 space-y-6 pb-24">
                        <!-- 日記將會動態地插入到這裡 -->
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      社群探索頁 (Explore)        ===== -->
            <!-- ================================================== -->
            <div id="explore-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex-shrink-0">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="搜尋日記、創作者或 #地點標籤..." class="w-full bg-gray-100 border border-gray-200 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-amber-400">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                    </div>
                </header>
                
                <!-- Tab Navigation -->
                <div class="flex justify-around border-b border-gray-200 bg-white flex-shrink-0">
                    <button data-tab="footprints" class="explore-tab py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent w-full">最近足跡</button>
                    <button data-tab="discover" class="explore-tab py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent w-full active">探索</button>
                    <button data-tab="following" class="explore-tab py-3 px-4 font-semibold text-gray-500 border-b-2 border-transparent w-full">追蹤</button>
                </div>

                <div class="overflow-y-auto flex-1">
                    <!-- Discover Content (Original Explore Page) -->
                    <div id="discover-content" class="tab-content">
                        <main class="p-4 pb-24">
                            <h2 class="text-base font-bold text-gray-700 mt-6 mb-3">精選日記</h2>
                            <div id="explore-diaries-grid" class="masonry">
                                <!-- Public diaries will be dynamically inserted here -->
                            </div>
                        </main>
                    </div>

                    <!-- Footprints Content -->
                    <div id="footprints-content" class="tab-content hidden">
                        <main class="p-4 pb-24 space-y-4">
                            <div class="relative mb-4 rounded-lg overflow-hidden shadow-md">
                                <img src="https://storage.googleapis.com/gemini-prod-us-west1-423901-8354/images/20240810_taiwan_map_prototype.png" alt="台灣足跡地圖" class="w-full h-48 object-cover">
                                <!-- Map Pins -->
                                <div class="map-pin" style="top: 25%; left: 78%;" title="台北市，陽明山"></div>
                                <div class="map-pin" style="top: 35%; left: 85%;" title="宜蘭縣，冬山河親水公園"></div>
                                <div class="map-pin" style="top: 80%; left: 20%;" title="我們溫暖的家 (高雄)"></div>
                            </div>
                            <div class="flex items-center bg-white p-3 rounded-lg shadow-sm">
                                <img src="https://placehold.co/100x100/34D399/FFFFFF?text=山" class="w-16 h-16 rounded-lg object-cover mr-4">
                                <div>
                                    <h3 class="font-bold">陽明山繡球花之旅</h3>
                                    <p class="text-sm text-gray-500">2025年8月4日</p>
                                    <p class="text-xs text-gray-400">1 則日記</p>
                                </div>
                            </div>
                             <div class="flex items-center bg-white p-3 rounded-lg shadow-sm">
                                <img src="https://placehold.co/100x100/FBBF24/FFFFFF?text=家" class="w-16 h-16 rounded-lg object-cover mr-4">
                                <div>
                                    <h3 class="font-bold">我們溫暖的家</h3>
                                    <p class="text-sm text-gray-500">2025年7月20日</p>
                                    <p class="text-xs text-gray-400">3 則日記</p>
                                </div>
                            </div>
                            <div class="flex items-center bg-white p-3 rounded-lg shadow-sm">
                                <img src="https://placehold.co/100x100/60A5FA/FFFFFF?text=水" class="w-16 h-16 rounded-lg object-cover mr-4">
                                <div>
                                    <h3 class="font-bold">宜蘭縣冬山河親水公園</h3>
                                    <p class="text-sm text-gray-500">2025年7月5日</p>
                                    <p class="text-xs text-gray-400">1 則日記</p>
                                </div>
                            </div>
                        </main>
                    </div>

                    <!-- Following Content -->
                    <div id="following-content" class="tab-content hidden">
                        <main class="pb-24">
                            <!-- Stories Section -->
                            <div class="p-4 border-b border-gray-200 bg-white">
                                <h3 class="text-sm font-semibold text-gray-600 mb-3">即時動態</h3>
                                <div class="flex space-x-4 overflow-x-auto pb-2 tag-carousel">
                                    <!-- Story Item with new story -->
                                    <div class="text-center flex-shrink-0 cursor-pointer">
                                        <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover" src="https://placehold.co/100x100/dbeafe/1e3a8a?text=爸" alt="Creator 2">
                                            <div class="absolute inset-0 rounded-full ring-2 ring-amber-400 ring-offset-2"></div>
                                        </div>
                                        <p class="text-xs mt-2">攝影老爸</p>
                                    </div>
                                    <!-- Story Item already viewed -->
                                    <div class="text-center flex-shrink-0 cursor-pointer">
                                         <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover border-2 border-gray-300" src="https://placehold.co/100x100/fde68a/a16207?text=媽" alt="Creator 1">
                                        </div>
                                        <p class="text-xs mt-2">旅行的媽咪</p>
                                    </div>
                                    <div class="text-center flex-shrink-0 cursor-pointer">
                                         <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover border-2 border-gray-300" src="https://placehold.co/100x100/fce7f3/831843?text=娃" alt="Creator 3">
                                        </div>
                                        <p class="text-xs mt-2">娃娃看天下</p>
                                    </div>
                                     <div class="text-center flex-shrink-0 cursor-pointer">
                                        <div class="relative w-16 h-16 mx-auto">
                                            <img class="w-full h-full rounded-full p-1 object-cover ring-2 ring-amber-400 ring-offset-2" src="https://placehold.co/100x100/4ade80/ffffff?text=寶" alt="Creator 4">
                                        </div>
                                        <p class="text-xs mt-2">寶寶去哪兒</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Feed Section -->
                            <div class="p-4 space-y-6">
                                <div class="memory-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer">
                                    <div class="p-4 flex items-center space-x-3 border-b">
                                        <img class="w-10 h-10 rounded-full" src="https://placehold.co/100x100/dbeafe/1e3a8a?text=爸" alt="Creator 2">
                                        <div>
                                            <p class="font-semibold text-sm">攝影老爸</p>
                                            <p class="text-xs text-gray-400">2 小時前</p>
                                        </div>
                                    </div>
                                    <img src="https://placehold.co/600x400/f87171/ffffff?text=野餐" alt="城市公園的午後野餐" class="w-full h-48 object-cover">
                                    <div class="p-4">
                                        <h2 class="text-lg font-bold text-gray-800">城市公園的午後野餐</h2>
                                        <p class="text-sm text-gray-600 mt-2">今天天氣真好，帶著家人一起到公園野餐，享受悠閒的午後時光...</p>
                                    </div>
                                </div>
                                <div class="memory-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer">
                                    <div class="p-4 flex items-center space-x-3 border-b">
                                        <img class="w-10 h-10 rounded-full" src="https://placehold.co/100x100/fde68a/a16207?text=媽" alt="Creator 1">
                                        <div>
                                            <p class="font-semibold text-sm">旅行的媽咪</p>
                                            <p class="text-xs text-gray-400">昨天</p>
                                        </div>
                                    </div>
                                    <img src="https://placehold.co/600x400/fb923c/ffffff?text=露營" alt="我們的第一次森林露營" class="w-full h-48 object-cover">
                                    <div class="p-4">
                                        <h2 class="text-lg font-bold text-gray-800">我們的第一次森林露營</h2>
                                        <p class="text-sm text-gray-600 mt-2">夜晚的星空好美，孩子們第一次看到這麼多星星，都興奮得睡不著覺！</p>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            </div>
            
            <!-- ================================================== -->
            <!-- =====      搜尋結果頁 (Search Results)   ===== -->
            <!-- ================================================== -->
            <div id="search-results-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button>
                    <h1 id="search-results-title" class="text-base font-bold text-gray-800 mx-auto">搜尋結果</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-4 pb-24">
                        <div id="search-results-grid" class="masonry">
                           <!-- Search results will be injected here -->
                        </div>
                    </main>
                </div>
            </div>


            <!-- ================================================== -->
            <!-- =====    創作者個人主頁 (Profile)      ===== -->
            <!-- ================================================== -->
            <div id="profile-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button>
                    <h1 class="text-base font-bold text-gray-800 mx-auto">旅行的媽咪</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="pb-24">
                        <div class="p-4 text-center bg-white">
                            <img class="w-24 h-24 rounded-full border-4 border-white shadow-lg mx-auto -mt-16" src="https://placehold.co/100x100/fde68a/a16207?text=媽" alt="Creator 1">
                            <h2 class="text-xl font-bold mt-4">旅行的媽咪</h2>
                            <p class="text-sm text-gray-500 mt-1">@travelmom_tw</p>
                            <p class="text-sm text-gray-700 mt-4 max-w-md mx-auto">帶著兩個孩子探索台灣的美好角落。<br>熱愛露營、手作與咖啡廳。</p>
                            <div class="flex justify-center space-x-6 mt-4">
                                <div class="text-center">
                                    <p class="font-bold text-lg">128</p>
                                    <p class="text-xs text-gray-500">日記</p>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-lg">15.2k</p>
                                    <p class="text-xs text-gray-500">粉絲</p>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-lg">180</p>
                                    <p class="text-xs text-gray-500">追蹤中</p>
                                </div>
                            </div>
                            <button class="mt-6 w-full bg-amber-500 text-white font-bold py-2 rounded-lg">追蹤</button>
                        </div>
                        <div class="p-4">
                            <div class="masonry">
                                <div class="masonry-item"><div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer"><img src="https://placehold.co/400x500/fb923c/ffffff?text=露營" alt="Diary 1"><div class="p-3"><p class="text-sm font-semibold truncate">我們的第一次森林露營</p><div class="flex items-center text-xs text-gray-400 mt-2"><span class="mr-3 flex items-center">👁️ 8.2k</span><span class="flex items-center">❤️ 1.2k</span></div></div></div></div>
                                <div class="masonry-item"><div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer"><img src="https://placehold.co/400x600/4ade80/ffffff?text=農場" alt="Diary 4"><div class="p-3"><p class="text-sm font-semibold truncate">清境農場餵羊初體驗</p><div class="flex items-center text-xs text-gray-400 mt-2"><span class="mr-3 flex items-center">👁️ 9.8k</span><span class="flex items-center">❤️ 2.3k</span></div></div></div></div>
                                <div class="masonry-item"><div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer"><img src="https://placehold.co/400x400/a78bfa/ffffff?text=古蹟" alt="Diary 3"><div class="p-3"><p class="text-sm font-semibold truncate">台南古蹟散步</p><div class="flex items-center text-xs text-gray-400 mt-2"><span class="mr-3 flex items-center">👁️ 4.1k</span><span class="flex items-center">❤️ 760</span></div></div></div></div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      建立新日記頁 (Create)         ===== -->
            <!-- ================================================== -->
            <div id="create-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button>
                    <h1 class="text-base font-bold text-gray-800">建立新的回憶</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-5 pb-24">
                        <h2 class="text-lg font-semibold text-gray-700 mb-3">
                            <span id="photo-count">已選取的照片 (0)</span>
                        </h2>
                        <div id="photo-grid-container" class="grid grid-cols-2 gap-4">
                            <label for="photo-upload" class="aspect-square bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span class="mt-2 text-sm text-gray-500">新增照片</span>
                            </label>
                        </div>
                        <input type="file" id="photo-upload" multiple accept="image/*" class="hidden">
                        
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">誰可以看見？</h3>
                            <select id="privacy-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="private">🔒 僅限自己</option>
                                <option value="group">👨‍👩‍👧‍👦 特定群組</option>
                                <option value="public">🌐 公開到社群</option>
                            </select>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">AI 寫作風格</h3>
                            <div class="space-y-2">
                                <label class="flex items-start p-3 bg-white border-2 border-amber-400 rounded-lg"><input type="radio" name="writing-style" value="warm" class="mt-1 text-amber-500 focus:ring-amber-400" checked><div class="ml-3"><p class="font-semibold">溫馨感性風</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="writing-style" value="fun" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">活潑有趣風</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="writing-style" value="simple" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">簡潔紀錄風</p></div></label>
                                <div class="p-3 bg-white border rounded-lg">
                                    <label class="flex items-start"><input type="radio" name="writing-style" value="custom" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3 flex-1"><p class="font-semibold">✍️ 自訂風格</p><textarea id="custom-prompt" class="w-full mt-2 p-2 border rounded text-sm bg-gray-50" rows="3" placeholder="請輸入您希望的寫作風格提示詞，例如：請用古龍的武俠小說風格來寫..." disabled></textarea></div></label>
                                </div>
                            </div>
                        </div>
                        <div id="create-error" class="text-red-500 text-xs italic mt-4 h-4 text-center"></div>
                    </main>
                </div>
                <footer class="p-5 bg-white/80 backdrop-blur-sm border-t border-gray-200 flex-shrink-0">
                    <button id="generate-diary-button" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-amber-600 transition-all disabled:bg-gray-300 disabled:shadow-none flex items-center justify-center" disabled>
                        ✨ AI 自動生成日記
                    </button>
                </footer>
            </div>

            <!-- ================================================== -->
            <!-- =====      日記詳情頁 (Detail)           ===== -->
            <!-- ================================================== -->
            <div id="detail-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-20 flex justify-between items-center border-b border-gray-200 flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button>
                    
                    <!-- Center Content -->
                    <div class="flex-1 flex flex-col justify-center items-center overflow-hidden h-full">
                        <div id="detail-header-content" class="flex items-center space-x-2">
                            <img id="detail-author-avatar" class="w-6 h-6 rounded-full bg-gray-200" style="display: none;">
                            <p id="detail-header-text" class="text-2xl font-bold text-gray-800 truncate"></p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2 w-20 justify-end">
                        <button id="share-button" class="text-gray-600 hover:text-gray-900 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg></button>
                        <button id="edit-button" class="text-gray-600 hover:text-gray-900 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg></button>
                    </div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main id="detail-content-container" class="pb-6">
                        <!-- Diary content will be dynamically inserted here -->
                    </main>
                </div>
                <div id="share-modal-container" class="modal-container absolute inset-0 z-30"><div id="share-modal-backdrop" class="absolute inset-0 bg-black/40"></div><div id="share-modal-panel" class="absolute bottom-0 left-0 right-0 bg-slate-50 rounded-t-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold text-gray-900">分享這份回憶</h2><button id="close-modal-button" class="text-gray-400 hover:text-gray-700">&times;</button></div>
                <div class="mt-4">
                    <h3 class="text-base font-semibold text-gray-800 mb-3">分享給群組</h3>
                    <div class="space-y-2">
                        <button class="share-group-button w-full text-left bg-white p-3 rounded-lg border flex items-center"><span>👨‍👩‍👧‍👦</span><span class="ml-3">家人群組</span></button>
                        <button class="share-group-button w-full text-left bg-white p-3 rounded-lg border flex items-center"><span>🧑‍🤝‍🧑</span><span class="ml-3">朋友群組</span></button>
                        <button class="share-group-button w-full text-left bg-white p-3 rounded-lg border flex items-center"><span>🏕️</span><span class="ml-3">露營好夥伴</span></button>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-lg border mt-4"><p class="text-xs text-gray-500 mb-2">或複製私密連結：</p><div class="flex items-center space-x-2"><input type="text" value="https://our-app.com/diary/xyz123" class="text-sm text-gray-600 bg-gray-100 p-2 rounded w-full truncate" readonly><button id="copy-link-button" class="bg-amber-500 text-white px-3 py-2 rounded-md text-sm font-semibold whitespace-nowrap">複製</button></div></div><div class="mt-6"><button id="done-button" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-gray-900">完成</button></div></div></div>
            </div>

            <!-- ================================================== -->
            <!-- =====      編輯日記頁 (Edit)           ===== -->
            <!-- ================================================== -->
            <div id="edit-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900">返回</button>
                    <h1 class="text-base font-bold text-gray-800">編輯日記</h1>
                    <button id="save-button" class="text-amber-500 font-bold">儲存</button>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-5">
                        <div class="mb-6">
                            <label class="text-lg font-semibold text-gray-700">標題</label>
                            <input type="text" id="edit-title" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                        </div>
                        <div class="mb-6">
                            <label class="text-lg font-semibold text-gray-700">總結故事</label>
                            <textarea id="edit-overall-story" class="w-full mt-2 p-3 border border-gray-300 rounded-lg h-24 focus:ring-2 focus:ring-amber-400 focus:border-amber-400"></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="text-lg font-semibold text-gray-700 mb-2">誰可以看見？</label>
                            <select id="edit-privacy-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                                <option value="private">🔒 僅限自己</option>
                                <option value="group">👨‍👩‍👧‍👦 特定群組</option>
                                <option value="public">🌐 公開到社群</option>
                            </select>
                        </div>
                        <hr class="my-6">
                        <div id="edit-events-container" class="space-y-6">
                            <!-- Dynamic event editors will be inserted here -->
                        </div>
                        <hr class="my-8 border-dashed">
                        <div id="edit-style-container" class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">AI 風格重塑</h3>
                             <div class="space-y-2">
                                <label class="flex items-start p-3 bg-white border-2 border-amber-400 rounded-lg"><input type="radio" name="edit-writing-style" value="warm" class="mt-1 text-amber-500 focus:ring-amber-400" checked><div class="ml-3"><p class="font-semibold">溫馨感性風</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="edit-writing-style" value="fun" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">活潑有趣風</p></div></label>
                                <label class="flex items-start p-3 bg-white border rounded-lg"><input type="radio" name="edit-writing-style" value="simple" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">簡潔紀錄風</p></div></label>
                            </div>
                            <button id="regenerate-button" class="mt-4 w-full bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-blue-600 transition-all flex items-center justify-center">
                                ✨ 套用新風格重寫
                            </button>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      生成中... (Loading)           ===== -->
            <!-- ================================================== -->
            <div id="loading-screen" class="page">
                <div class="m-auto text-center p-8"><div class="bg-amber-400 p-8 rounded-2xl"><svg class="animate-spin h-12 w-12 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><h2 class="text-2xl font-bold mt-6 text-white">AI 正在為您撰寫故事...</h2><p id="countdown-timer" class="mt-2 text-white/80">請稍候...</p></div></div>
            </div>
            
            <!-- ================================================== -->
            <!-- =====      設定頁 (Settings)             ===== -->
            <!-- ================================================== -->
            <div id="pro-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button>
                    <h1 class="text-base font-bold text-gray-800 mx-auto">設定</h1>
                    <div class="w-20"></div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <button id="go-to-profile-edit" class="w-full text-left bg-white p-4 rounded-lg border flex items-center mb-8">
                            <img id="settings-avatar" class="w-12 h-12 rounded-full" src="https://placehold.co/100x100/e2e8f0/475569?text=?" alt="User Avatar">
                            <div class="ml-4 flex-1">
                                <p id="settings-display-name" class="font-bold">訪客</p>
                                <p id="settings-username" class="text-xs text-gray-500">@guest</p>
                            </div>
                            <span>&gt;</span>
                        </button>
                        <div class="mt-8 space-y-2">
                             <button id="go-to-earnings" class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>💰 創作者收益中心</span><span>&gt;</span></button>
                             <button id="go-to-groups" class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>👨‍👩‍👧‍👦 管理我的群組</span><span>&gt;</span></button>
                             <button id="go-to-writing-style" class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>✍️ AI 寫作風格</span><span>&gt;</span></button>
                             <button class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>🔔 通知設定</span><span>&gt;</span></button>
                             <button id="logout-button" class="w-full text-left text-red-500 bg-white p-4 rounded-lg border">登出帳號</button>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    創作者收益頁 (Earnings)       ===== -->
            <!-- ================================================== -->
            <div id="earnings-screen" class="page">
                 <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button><h1 class="text-base font-bold text-gray-800 mx-auto">創作者收益</h1><div class="w-20"></div></header>
                 <div class="overflow-y-auto flex-1">
                       <main class="p-6">
                           <div class="bg-white p-5 rounded-xl shadow-lg text-center">
                               <p class="text-sm text-gray-500">目前總收益</p>
                               <p class="text-4xl font-bold text-gray-800 my-2">NT$ 850</p>
                               <button class="bg-green-500 text-white font-bold py-2 px-8 rounded-full">提領</button>
                           </div>
                           <div class="grid grid-cols-2 gap-4 mt-6">
                               <div class="bg-white p-3 rounded-xl shadow"><p class="text-xs text-gray-500">今日預估收益</p><p class="font-bold text-lg">NT$ 15</p></div>
                               <div class="bg-white p-3 rounded-xl shadow"><p class="text-xs text-gray-500">本月累計</p><p class="font-bold text-lg">NT$ 320</p></div>
                           </div>
                           <div class="mt-8">
                               <h3 class="font-bold mb-2">收益趨勢 (近30日)</h3>
                               <div class="bg-white p-4 rounded-xl shadow">
                                   <img src="https://placehold.co/600x200/f0f9ff/0284c7?text=收益趨勢圖" alt="收益趨勢圖" class="w-full">
                               </div>
                           </div>
                           <div class="mt-8">
                               <h3 class="font-bold mb-2">熱門日記排行榜</h3>
                               <div class="space-y-3">
                                   <div class="bg-white p-3 rounded-xl shadow flex items-center space-x-3">
                                       <img src="https://placehold.co/100x100/34D399/FFFFFF?text=親子" class="w-16 h-16 rounded-lg object-cover">
                                       <div class="flex-1"><p class="font-bold text-sm">陽明山繡球花之旅</p><p class="text-xs text-gray-500">觀看 8.2k次・收益 NT$ 125</p></div>
                                   </div>
                                    <div class="bg-white p-3 rounded-xl shadow flex items-center space-x-3">
                                       <img src="https://placehold.co/100x100/fb923c/ffffff?text=露營" class="w-16 h-16 rounded-lg object-cover">
                                       <div class="flex-1"><p class="font-bold text-sm">我們的第一次森林露營</p><p class="text-xs text-gray-500">觀看 6.5k次・收益 NT$ 98</p></div>
                                   </div>
                               </div>
                           </div>
                       </main>
                 </div>
            </div>
            
            <!-- ================================================== -->
            <!-- =====      管理群組頁 (Groups)           ===== -->
            <!-- ================================================== -->
            <div id="groups-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button><h1 class="text-base font-bold text-gray-800 mx-auto">管理我的群組</h1><div class="w-20"></div></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div class="space-y-3">
                            <button class="group-item w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><div><p>👨‍👩‍👧‍👦 家人群組</p><p class="text-xs text-gray-500">5 位成員</p></div><span>&gt;</span></button>
                            <button class="group-item w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><div><p>🧑‍🤝‍🧑 朋友群組</p><p class="text-xs text-gray-500">12 位成員</p></div><span>&gt;</span></button>
                            <button class="group-item w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><div><p>🏕️ 露營好夥伴</p><p class="text-xs text-gray-500">8 位成員</p></div><span>&gt;</span></button>
                        </div>
                        <button id="create-group-button" class="mt-6 w-full bg-amber-500 text-white font-bold py-3 rounded-lg">建立新群組</button>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    編輯群組頁 (Group Edit)       ===== -->
            <!-- ================================================== -->
            <div id="group-edit-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button><h1 class="text-base font-bold text-gray-800">編輯群組</h1><button class="text-amber-500 font-bold w-12 text-right">儲存</button></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div>
                            <label class="text-lg font-semibold text-gray-700">群組名稱</label>
                            <input type="text" value="家人群組" class="w-full mt-2 p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mt-6">
                             <h3 class="text-lg font-semibold text-gray-700 mb-2">成員 (5)</h3>
                             <div class="space-y-2">
                                 <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                                     <div class="flex items-center"><img src="https://placehold.co/100x100/fde68a/a16207?text=嬤" class="w-10 h-10 rounded-full mr-3"><span>阿嬤</span></div>
                                     <button class="text-red-500">移除</button>
                                 </div>
                                 <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                                     <div class="flex items-center"><img src="https://placehold.co/100x100/dbeafe/1e3a8a?text=爸" class="w-10 h-10 rounded-full mr-3"><span>爸爸</span></div>
                                     <button class="text-red-500">移除</button>
                                 </div>
                             </div>
                        </div>
                        <button id="add-member-button" class="mt-6 w-full bg-blue-500 text-white font-bold py-3 rounded-lg">＋ 新增成員</button>
                        <button class="mt-8 w-full text-red-500 font-semibold py-2">刪除群組</button>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====  建立新群組頁 (Group Create)     ===== -->
            <!-- ================================================== -->
            <div id="group-create-screen" class="page">
                 <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button><h1 class="text-base font-bold text-gray-800">建立新群組</h1><button class="text-amber-500 font-bold w-12 text-right">建立</button></header>
                 <div class="overflow-y-auto flex-1">
                       <main class="p-6">
                           <div class="flex flex-col items-center">
                               <button id="emoji-picker-button" class="text-6xl bg-white rounded-full h-24 w-24 flex items-center justify-center shadow-md mb-4">🍽️</button>
                               <input type="text" placeholder="請輸入群組名稱" class="w-full text-center text-xl font-bold p-2 border-b-2 focus:outline-none focus:border-amber-500">
                           </div>
                           <div class="mt-8">
                               <h3 class="text-lg font-semibold text-gray-700 mb-2">新增成員</h3>
                               <div class="relative"><input type="text" placeholder="搜尋使用者名稱..." class="w-full bg-white border border-gray-200 rounded-full py-2 pl-10 pr-4"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div></div>
                           </div>
                       </main>
                 </div>
            </div>

             <!-- ================================================== -->
            <!-- =====    編輯個人資料頁 (Profile Edit)   ===== -->
            <!-- ================================================== -->
            <div id="profile-edit-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-between items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button><h1 class="text-base font-bold text-gray-800">編輯個人資料</h1><button id="save-profile-button" class="text-amber-500 font-bold w-12 text-right">儲存</button></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div class="flex flex-col items-center">
                            <div class="relative">
                                <img id="profile-edit-avatar" class="w-24 h-24 rounded-full" src="https://placehold.co/100x100/fde68a/a16207?text=林" alt="User Avatar">
                                <button class="absolute -bottom-1 -right-1 bg-white rounded-full p-1 border shadow"><svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                            </div>
                        </div>
                        <div class="mt-8 space-y-4">
                            <div><label class="text-sm font-semibold text-gray-600">使用者名稱</label><input type="text" id="profile-edit-username" class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-gray-100" readonly></div>
                            <div><label class="text-sm font-semibold text-gray-600">顯示名稱</label><input type="text" id="profile-edit-display-name" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></div>
                            <div><label class="text-sm font-semibold text-gray-600">個人簡介</label><textarea id="profile-edit-bio" class="w-full mt-1 p-2 border border-gray-300 rounded-lg h-24"></textarea></div>
                            <div><label class="text-sm font-semibold text-gray-600">電子郵件</label><input type="email" id="profile-edit-email" class="w-full mt-1 p-2 border border-gray-300 rounded-lg"></div>
                            <button class="w-full text-blue-600 text-left pt-2">更改密碼</button>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    AI 寫作風格頁 (Writing Style)   ===== -->
            <!-- ================================================== -->
            <div id="writing-style-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex items-center flex-shrink-0"><button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button><h1 class="text-base font-bold text-gray-800 mx-auto">AI 寫作風格</h1><div class="w-20"></div></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6">
                        <div class="space-y-3">
                            <label class="flex items-start p-4 bg-white border-2 border-amber-400 rounded-lg"><input type="radio" name="writing-style-option" class="mt-1 text-amber-500 focus:ring-amber-400" checked><div class="ml-3"><p class="font-semibold">溫馨感性風</p><p class="text-sm text-gray-500">充滿溫度與情感，適合記錄家庭的溫暖瞬間。</p></div></label>
                            <label class="flex items-start p-4 bg-white border rounded-lg"><input type="radio" name="writing-style-option" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">活潑有趣風</p><p class="text-sm text-gray-500">用字俏皮，多用驚嘆號，適合記錄歡樂的出遊。</p></div></label>
                            <label class="flex items-start p-4 bg-white border rounded-lg"><input type="radio" name="writing-style-option" class="mt-1 text-amber-500 focus:ring-amber-400"><div class="ml-3"><p class="font-semibold">簡潔紀錄風</p><p class="text-sm text-gray-500">像旅遊雜誌般，客觀記錄時間、地點與事件。</p></div></label>
                             <label class="flex items-start p-4 bg-white border rounded-lg">
                                 <input type="radio" name="writing-style-option" value="custom" class="mt-1 text-amber-500 focus:ring-amber-400">
                                 <div class="ml-3 flex-1">
                                     <p class="font-semibold">✍️ 自訂風格</p>
                                     <textarea id="custom-prompt-style" class="w-full mt-2 p-2 border rounded text-sm bg-gray-50" rows="3" placeholder="請輸入您希望的寫作風格提示詞，例如：請用古龍的武俠小說風格來寫..." disabled></textarea>
                                 </div>
                             </label>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====  互動式提問頁 (Interactive Question) ===== -->
            <!-- ================================================== -->
            <div id="interactive-question-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-200 flex justify-end items-center flex-shrink-0"><button id="skip-question-button" class="text-gray-500 hover:text-gray-800">跳過</button></header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-6 text-center flex flex-col justify-center h-full">
                        <div class="flex-grow">
                            <p class="text-lg text-gray-600 mb-4">AI 偵探發現...</p>
                            <div class="flex -space-x-4 justify-center mb-6">
                                <img class="w-16 h-16 rounded-full border-2 border-white object-cover" src="https://placehold.co/100x100/34D399/FFFFFF?text=1">
                                <img class="w-16 h-16 rounded-full border-2 border-white object-cover" src="https://placehold.co/100x100/A78BFA/FFFFFF?text=2">
                                <img class="w-16 h-16 rounded-full border-2 border-white object-cover" src="https://placehold.co/100x100/FBCFE8/FFFFFF?text=3">
                            </div>
                            <p class="text-xl font-semibold text-gray-800">你們在花海中笑得好開心！</p>
                            <p class="text-xl font-semibold text-gray-800 mt-1">那天最難忘的瞬間是什麼呢？</p>
                            <textarea class="w-full mt-6 p-3 border border-gray-300 rounded-lg h-28" placeholder="告訴 AI 更多細節，讓故事更精彩..."></textarea>
                        </div>
                        <button id="continue-generation-button" class="w-full bg-amber-500 text-white font-bold py-3 rounded-lg mt-6">繼續生成</button>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====      冒險頁 (Adventure)          ===== -->
            <!-- ================================================== -->
            <div id="adventure-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex-shrink-0">
                    <div class="flex justify-between items-center">
                        <h1 class="text-xl font-bold text-gray-800">親子大冒險</h1>
                    </div>
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="p-4 space-y-4 pb-24">
                        <!-- Adventure Card 1 -->
                        <div class="adventure-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
                            <div class="p-4">
                                <div class="flex items-start space-x-4">
                                    <div class="text-4xl">🏙️</div>
                                    <div class="flex-1">
                                        <h2 class="text-lg font-bold text-gray-800">城市光影獵人</h2>
                                        <p class="text-sm text-gray-600 mt-1">帶著相機，捕捉城市裡最特別的5個光影瞬間。</p>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                            <div class="bg-amber-500 h-2.5 rounded-full" style="width: 40%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">進度: 2 / 5 個任務</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Adventure Card 2 -->
                        <div class="adventure-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
                            <div class="p-4">
                                <div class="flex items-start space-x-4">
                                    <div class="text-4xl">🍳</div>
                                    <div class="flex-1">
                                        <h2 class="text-lg font-bold text-gray-800">週末野炊王</h2>
                                        <p class="text-sm text-gray-600 mt-1">從採買到烹飪，完成一道全家共享的戶外料理！</p>
                                         <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                            <div class="bg-amber-500 h-2.5 rounded-full" style="width: 80%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">進度: 4 / 5 個任務</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <!-- Adventure Card 3 -->
                        <div class="adventure-card bg-white rounded-xl shadow-md overflow-hidden cursor-pointer hover:shadow-lg transition-shadow">
                            <div class="p-4">
                                <div class="flex items-start space-x-4">
                                    <div class="text-4xl">🗺️</div>
                                    <div class="flex-1">
                                        <h2 class="text-lg font-bold text-gray-800">社區尋寶家</h2>
                                        <p class="text-sm text-gray-600 mt-1">找出社區裡5個隱藏的特殊地標或符號。</p>
                                         <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                            <div class="bg-amber-500 h-2.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">進度: 0 / 5 個任務</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            </div>

            <!-- ================================================== -->
            <!-- =====    冒險詳情頁 (Adventure Detail)   ===== -->
            <!-- ================================================== -->
            <div id="adventure-detail-screen" class="page">
                <header class="p-4 pt-8 bg-white/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200 flex items-center flex-shrink-0">
                    <button class="go-back-button text-gray-600 hover:text-gray-900 flex items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg><span>返回</span></button>
                    <h1 class="text-base font-bold text-gray-800 mx-auto">城市光影獵人</h1>
                    <div class="w-20"></div> <!-- Placeholder for alignment -->
                </header>
                <div class="overflow-y-auto flex-1">
                    <main class="pb-24">
                        <img src="https://placehold.co/600x300/fbbf24/ffffff?text=城市光影" alt="Adventure Banner" class="w-full h-48 object-cover">
                        <div class="p-5">
                            <p class="text-gray-700 leading-relaxed">光和影是城市裡最神奇的魔法師。它們能把平凡的街道變成一幅畫，把普通的建築變成一座雕塑。這次的冒險，我們要化身為「光影獵人」，用眼睛和相機，去發現並捕捉那些藏在城市角落、稍縱即逝的美麗瞬間。</p>
                            
                            <h3 class="text-lg font-bold text-gray-800 mt-6 mb-3">任務清單 (2/5)</h3>
                            <div class="space-y-3">
                                <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400" checked>
                                    <span class="ml-3 text-gray-800">找到一個被陽光拉得長長的影子</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400" checked>
                                    <span class="ml-3 text-gray-800">拍下一張窗戶的倒影</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400">
                                    <span class="ml-3 text-gray-800">捕捉穿過樹葉的斑駁光點</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400">
                                    <span class="ml-3 text-gray-800">尋找夜晚霓虹燈在濕地上的倒影</span>
                                </label>
                                 <label class="flex items-center p-3 bg-white rounded-lg border shadow-sm">
                                    <input type="checkbox" class="h-5 w-5 rounded text-amber-500 focus:ring-amber-400">
                                    <span class="ml-3 text-gray-800">拍下夕陽時分建築物的金色輪廓</span>
                                </label>
                            </div>

                            <h3 class="text-lg font-bold text-gray-800 mt-8 mb-3">成果展示</h3>
                            <div class="grid grid-cols-3 gap-2">
                                <img src="https://placehold.co/200x200/fb923c/ffffff?text=影子" class="rounded-lg object-cover aspect-square">
                                <img src="https://placehold.co/200x200/f87171/ffffff?text=倒影" class="rounded-lg object-cover aspect-square">
                                <div class="aspect-square bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center cursor-pointer">
                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                </div>
                            </div>
                             <button class="mt-8 w-full bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-600 transition-all">
                                🎉 我完成冒險了！
                            </button>
                        </div>
                    </main>
                </div>
            </div>


            <!-- ===== 底部導覽列 ===== -->
            <nav id="bottom-nav" class="absolute bottom-0 left-0 right-0 h-20 bg-white/90 backdrop-blur-sm border-t border-gray-200 flex justify-around items-center z-20" style="display: none;">
                <button data-target="home-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg><p class="text-xs mt-1">首頁</p></button>
                <button data-target="explore-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m-6 3l6-3" /></svg><p class="text-xs mt-1">探索</p></button>
                <button id="fab-nav" class="bg-amber-500 hover:bg-amber-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center transform -mt-8"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                <button data-target="adventure-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v.01M12 12v.01M12 16v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-xs mt-1">冒險</p></button>
                <button data-target="pro-screen" class="bottom-nav-item text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><p class="text-xs mt-1">設定</p></button>
            </nav>
            
            <!-- ===== 新增成員彈窗 ===== -->
            <div id="add-member-modal-container" class="modal-container absolute inset-0 z-40"><div id="add-member-modal-backdrop" class="absolute inset-0 bg-black/40"></div><div id="add-member-modal-panel" class="absolute bottom-0 left-0 right-0 bg-slate-50 rounded-t-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold text-gray-900">新增成員</h2><button id="close-add-member-modal-button" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button></div><div class="relative"><input type="text" placeholder="搜尋使用者名稱..." class="w-full bg-white border border-gray-200 rounded-full py-2 pl-10 pr-4"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div></div><div class="mt-4 space-y-2"><div class="bg-white p-3 rounded-lg border flex justify-between items-center"><div class="flex items-center"><img src="https://placehold.co/100x100/dbeafe/1e3a8a?text=爸" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">攝影老爸</p><p class="text-xs text-gray-500">@photodad</p></div></div><button class="invite-button bg-blue-500 text-white text-sm font-semibold px-3 py-1 rounded-full">邀請</button></div><div class="bg-white p-3 rounded-lg border flex justify-between items-center"><div class="flex items-center"><img src="https://placehold.co/100x100/fce7f3/831843?text=娃" class="w-10 h-10 rounded-full mr-3"><div><p class="font-semibold">娃娃看天下</p><p class="text-xs text-gray-500">@wawaworld</p></div></div><button class="bg-gray-200 text-gray-500 text-sm font-semibold px-3 py-1 rounded-full cursor-not-allowed">已邀請</button></div></div>
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-500 mb-2">或</p>
                    <button id="generate-invite-link" class="w-full bg-green-500 text-white font-bold py-3 rounded-lg">產生邀請連結</button>
                    <div id="invite-link-details" class="hidden mt-4 bg-white p-4 rounded-lg text-left">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://our-app.com/join/abcde" class="mx-auto my-2">
                        <div class="flex items-center space-x-2 mt-2"><input type="text" value="https://our-app.com/join/abcde" class="text-sm text-gray-600 bg-gray-100 p-2 rounded w-full truncate" readonly><button id="copy-invite-link-button" class="bg-amber-500 text-white px-3 py-2 rounded-md text-sm font-semibold whitespace-nowrap">複製</button></div>
                        <div class="mt-4 space-y-2 text-sm">
                            <div class="flex justify-between items-center"><label for="expire-select">有效期</label><select id="expire-select" class="border rounded p-1"><option>1 天</option><option>7 天</option><option>永久</option></select></div>
                            <div class="flex justify-between items-center"><label for="limit-select">使用次數</label><select id="limit-select" class="border rounded p-1"><option>5 次</option><option>10 次</option><option>無限制</option></select></div>
                        </div>
                    </div>
                </div>
            </div></div>

            <!-- ===== 訪客提示彈窗 ===== -->
            <div id="guest-modal" class="modal-container absolute inset-0 z-50 flex items-center justify-center p-8">
                <div class="absolute inset-0 bg-black/40"></div>
                <div class="relative bg-white rounded-2xl p-6 text-center shadow-xl">
                    <h2 class="text-lg font-bold text-gray-800">需要登入喔！</h2>
                    <p class="text-sm text-gray-600 mt-2">為了確保您的珍貴回憶不會遺失，建立日記需要一個正式帳號。</p>
                    <div class="mt-6 flex flex-col space-y-2">
                        <button id="go-to-auth-button" class="w-full bg-amber-500 text-white font-bold py-2 px-4 rounded-lg">前往登入 / 註冊</button>
                        <button id="close-guest-modal-button" class="w-full text-gray-500 text-sm py-2 px-4 rounded-lg">稍後再說</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove, orderBy, setLogLevel, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAoVd0MJy5TjwuEF8xPntGmyu3tpHEUuts",
            authDomain: "family-time-capsule-ac438.firebaseapp.com",
            projectId: "family-time-capsule-ac438",
            storageBucket: "family-time-capsule-ac438.appspot.com",
            messagingSenderId: "717537356458",
            appId: "1:717537356458:web:59caf3c60cd45d2529bed3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        setLogLevel('debug'); // Enable debug logging for Firebase

        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.bottom-nav-item');
        const bottomNav = document.getElementById('bottom-nav');
        const greeting = document.getElementById('greeting');
        const authError = document.getElementById('auth-error');
        const createError = document.getElementById('create-error');
        const guestModal = document.getElementById('guest-modal');
        const diariesContainer = document.getElementById('diaries-container');
        
        let navigationStack = ['auth-screen']; // Start with auth screen
        let diariesUnsubscribe = null; // To hold the listener unsubscribe function
        let commentsUnsubscribe = null; // To hold the listener for comments
        let userProfileUnsubscribe = null;
        let currentUserProfile = null;
        let selectedFiles = []; // To store selected files globally
        let currentDiary = null; // To hold the currently viewed diary object
        let selectedCoverIndex = 0; // To store the user-selected cover photo index
        const userProfileCache = {}; // Cache for author profiles

        async function getAuthorProfile(authorId) {
            if (userProfileCache[authorId]) {
                return userProfileCache[authorId];
            }
            try {
                const userDocRef = doc(db, "users", authorId);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const profile = docSnap.data();
                    userProfileCache[authorId] = profile;
                    return profile;
                }
            } catch (e) {
                console.error("Could not fetch author profile:", e);
            }
            return null;
        }

        function showPage(targetId, isSubPage = false) {
            pages.forEach(page => {
                page.classList.toggle('is-active', page.id === targetId);
            });
            
            const showNav = !isSubPage && targetId !== 'auth-screen';
            bottomNav.style.display = showNav ? 'flex' : 'none';
        }
        
        function navigateTo(targetId) {
            const isSubPage = !['home-screen', 'explore-screen', 'auth-screen', 'adventure-screen', 'pro-screen'].includes(targetId);
            showPage(targetId, isSubPage);
            if (navigationStack[navigationStack.length - 1] !== targetId) {
                navigationStack.push(targetId);
            }
        }

        function goBack() {
            if (commentsUnsubscribe) {
                commentsUnsubscribe();
                commentsUnsubscribe = null;
            }
            if (navigationStack.length > 1) {
                navigationStack.pop();
                const targetId = navigationStack[navigationStack.length - 1];
                const isSubPage = !['home-screen', 'explore-screen', 'auth-screen', 'adventure-screen', 'pro-screen'].includes(targetId);
                showPage(targetId, isSubPage);
                navItems.forEach(nav => {
                    nav.classList.toggle('active', nav.dataset.target === targetId);
                });
            }
        }
        
        function renderComments(comments) {
            const commentsList = document.getElementById('comments-list');
            if (!commentsList) return;
            commentsList.innerHTML = '';
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">還沒有任何留言。</p>';
                return;
            }
            comments.forEach(comment => {
                const date = comment.createdAt ? comment.createdAt.toDate().toLocaleString('zh-TW') : '';
                const commentEl = document.createElement('div');
                commentEl.className = 'flex items-start space-x-3';
                let imageHTML = '';
                if (comment.imageUrl) {
                    imageHTML = `<img src="${comment.imageUrl}" class="mt-2 rounded-lg max-w-full h-auto" style="max-height: 150px;">`;
                }
                commentEl.innerHTML = `
                    <img class="w-8 h-8 rounded-full" src="https://placehold.co/100x100/e2e8f0/475569?text=${comment.authorName.charAt(0)}" alt="${comment.authorName}">
                    <div class="flex-1">
                        <div class="bg-gray-100 rounded-lg p-3">
                            <p class="font-semibold text-sm">${comment.authorName}</p>
                            <p class="text-sm text-gray-800">${comment.text}</p>
                            ${imageHTML}
                        </div>
                        <p class="text-xs text-gray-400 mt-1">${date}</p>
                    </div>
                `;
                commentsList.appendChild(commentEl);
            });
        }

        async function showDiaryDetail(diary) {
            currentDiary = diary; 
            const detailContainer = document.getElementById('detail-content-container');
            detailContainer.innerHTML = ''; 

            const authorAvatar = document.getElementById('detail-author-avatar');
            const headerTextElement = document.getElementById('detail-header-text');
            let mainTitleText = '';
            const title = diary.title || '';
            const parts = title.split(/[:：]/);

            if (parts.length > 1) {
                const headerText = parts[0].trim();
                mainTitleText = parts.slice(1).join(':').trim();
                authorAvatar.style.display = 'none';
                headerTextElement.textContent = headerText;
            } else {
                const authorProfile = await getAuthorProfile(diary.authorId);
                authorAvatar.style.display = 'block';
                if (authorProfile) {
                    const name = authorProfile.displayName || '作者';
                    authorAvatar.src = `https://placehold.co/100x100/fde68a/a16207?text=${name.charAt(0).toUpperCase()}`;
                    headerTextElement.textContent = name;
                } else {
                    authorAvatar.src = 'https://placehold.co/100x100/e2e8f0/475569?text=?';
                    headerTextElement.textContent = '匿名作者';
                }
                mainTitleText = title;
            }
            
            const date = diary.createdAt ? diary.createdAt.toDate().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' }) : '';

            let eventsArray = diary.events;
            if (typeof eventsArray === 'string') {
                try { eventsArray = JSON.parse(eventsArray); } catch (e) { eventsArray = []; }
            }
            
            const user = auth.currentUser;
            const likes = diary.likes || [];
            const isLiked = user ? likes.includes(user.uid) : false;
            let selectedCommentPhoto = null;

            const contentHTML = `
                <div class="p-5">
                    <p class="text-lg text-gray-500 mb-2">${date}</p>
                    <h1 class="text-3xl font-bold text-gray-900 mb-8">${mainTitleText}</h1>
                     <div class="summary-note">
                         <p class="text-2xl text-gray-700 leading-relaxed">${diary.overall_story || ''}</p>
                     </div>
                    <hr class="my-8 border-gray-200">
                </div>
                <div class="relative px-5 py-2">${(diary.photoURLs || []).map((imageUrl, index) => {
                    const event = eventsArray[index] || {};
                    return `
                        <div class="timeline-item">
                             <div class="timeline-dot"></div>
                             <div class="w-full bg-black rounded-lg overflow-hidden mb-4 shadow-lg">
                                <img src="${imageUrl}" alt="事件照片 ${index + 1}" class="w-full h-auto object-contain block" style="max-height: 70vh;">
                             </div>
                            <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-2 mb-3 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="col-start-1 row-start-1 h-5 w-5 text-sky-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="col-start-2 row-start-1 text-gray-600">${event.time || '未知時間'}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="col-start-1 row-start-2 h-5 w-5 text-rose-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span class="col-start-2 row-start-2 text-gray-600">${event.location || '未知地點'}</span>
                            </div>
                            <p class="text-base text-gray-700 leading-relaxed">${event.description || ''}</p>
                        </div>
                    `;
                }).join('')}</div>
                
                <div class="p-5 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <button class="like-button flex items-center space-x-2 text-gray-600 hover:text-red-500 transition-colors ${isLiked ? 'liked' : ''}">
                           <svg class="heart-icon w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 20.25l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>
                            <span id="like-count" class="font-semibold">${likes.length}</span>
                        </button>
                    </div>
                    <div class="mt-6">
                         <h3 class="font-bold text-gray-800 mb-3">留言</h3>
                         <div id="comments-list" class="space-y-4"></div>
                         <form id="comment-form" class="mt-4">
                            <div id="comment-photo-preview-container" class="hidden mb-2 relative w-24 h-24">
                                <img id="comment-photo-preview" class="w-full h-full object-cover rounded-lg">
                                <button id="remove-comment-photo" type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center font-bold">&times;</button>
                            </div>
                             <div class="flex items-start space-x-2">
                                 <label for="comment-photo-upload" class="cursor-pointer p-2 text-gray-500 hover:text-amber-500">
                                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                 </label>
                                 <input type="file" id="comment-photo-upload" class="hidden" accept="image/*">
                                 <textarea id="comment-input" class="w-full p-2 border rounded-lg bg-gray-50 text-sm" rows="1" placeholder="新增留言..."></textarea>
                                 <button type="submit" class="bg-amber-500 text-white font-semibold px-4 py-2 rounded-lg">送出</button>
                             </div>
                         </form>
                    </div>
                </div>
            `;
            detailContainer.innerHTML = contentHTML;

            const likeButton = detailContainer.querySelector('.like-button');
            if(likeButton) {
                likeButton.addEventListener('click', async () => {
                    if (!user || user.isAnonymous) {
                         guestModal.classList.add('visible');
                         return;
                    }
                    const diaryRef = doc(db, "diaries", diary.id);
                    const newLikedState = !likeButton.classList.contains('liked');
                    await updateDoc(diaryRef, {
                        likes: newLikedState ? arrayUnion(user.uid) : arrayRemove(user.uid)
                    });
                });
            }
            
            const commentPhotoUpload = detailContainer.querySelector('#comment-photo-upload');
            const commentPhotoPreviewContainer = detailContainer.querySelector('#comment-photo-preview-container');
            const commentPhotoPreview = detailContainer.querySelector('#comment-photo-preview');
            const removeCommentPhoto = detailContainer.querySelector('#remove-comment-photo');

            commentPhotoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedCommentPhoto = file;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        commentPhotoPreview.src = event.target.result;
                        commentPhotoPreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeCommentPhoto.addEventListener('click', () => {
                selectedCommentPhoto = null;
                commentPhotoUpload.value = '';
                commentPhotoPreviewContainer.classList.add('hidden');
            });


            const commentForm = detailContainer.querySelector('#comment-form');
            if(commentForm) {
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!user || user.isAnonymous) {
                        guestModal.classList.add('visible');
                        return;
                    }
                    const commentInput = document.getElementById('comment-input');
                    const text = commentInput.value.trim();
                    
                    if (!text && !selectedCommentPhoto) return;

                    let imageUrl = null;
                    if (selectedCommentPhoto) {
                        const filePath = `comments/${user.uid}/${Date.now()}-${selectedCommentPhoto.name}`;
                        const storageRef = ref(storage, filePath);
                        const snapshot = await uploadBytes(storageRef, selectedCommentPhoto);
                        imageUrl = await getDownloadURL(snapshot.ref);
                    }

                    await addDoc(collection(db, "diaries", diary.id, "comments"), {
                        text: text,
                        authorId: user.uid,
                        authorName: currentUserProfile ? currentUserProfile.displayName : "訪客",
                        createdAt: serverTimestamp(),
                        imageUrl: imageUrl
                    });
                    
                    commentInput.value = '';
                    selectedCommentPhoto = null;
                    commentPhotoUpload.value = '';
                    commentPhotoPreviewContainer.classList.add('hidden');
                });
            }

            if (commentsUnsubscribe) commentsUnsubscribe();
            const commentsQuery = query(collection(db, "diaries", diary.id, "comments"), orderBy("createdAt", "asc"));
            commentsUnsubscribe = onSnapshot(commentsQuery, (snapshot) => {
                const comments = [];
                snapshot.forEach(doc => comments.push(doc.data()));
                renderComments(comments);
            });

            navigateTo('detail-screen');
        }


        function renderDiaries(diaries) {
            diariesContainer.innerHTML = ''; 
            
            if (diaries.length === 0) {
                diariesContainer.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-gray-500">還沒有任何日記喔！</p>
                        <button id="create-first-diary-button" class="mt-4 bg-amber-500 text-white font-bold py-2 px-4 rounded-lg">
                            建立第一篇回憶
                        </button>
                    </div>
                `;
                document.getElementById('create-first-diary-button').addEventListener('click', () => navigateTo('create-screen'));
                return;
            }

            diaries.forEach(diary => {
                const date = diary.createdAt ? diary.createdAt.toDate().toLocaleDateString('zh-TW') : '未知日期';
                const privacyIcon = diary.privacy === 'private' ? '🔒' : diary.privacy === 'group' ? '👨‍👩‍👧‍👦' : '🌐';
                const coverImage = (diary.photoURLs && diary.photoURLs.length > 0) 
                    ? diary.photoURLs[diary.coverPhotoIndex || 0] 
                    : `https://placehold.co/600x400/34D399/FFFFFF?text=${encodeURIComponent(diary.title)}`;
                
                let location = '';
                if (diary.events) {
                    try {
                        const eventsArray = JSON.parse(diary.events);
                        if (eventsArray.length > 0 && eventsArray[0].location) {
                            location = eventsArray[0].location;
                        }
                    } catch(e) { /* Do nothing */ }
                }

                const diaryCard = document.createElement('div');
                diaryCard.className = 'memory-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition-shadow duration-300';
                diaryCard.innerHTML = `
                    <img src="${coverImage}" alt="${diary.title}" class="w-full h-40 object-cover">
                    <div class="p-4 relative">
                        <h2 class="text-lg font-bold text-gray-800 truncate">${diary.title}</h2>
                        <div class="flex items-center justify-between mt-2">
                            <p class="text-sm text-amber-700 font-medium">${date}</p>
                            ${location ? `
                            <div class="flex items-center space-x-1 text-xs bg-sky-100 text-sky-800 px-2 py-1 rounded-full font-semibold">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span>${location}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="absolute top-2 right-2 text-gray-400" title="${diary.privacy}">${privacyIcon}</div>
                    </div>
                `;
                diaryCard.addEventListener('click', () => showDiaryDetail(diary));
                diariesContainer.appendChild(diaryCard);
            });
        }
        
        function updateUserInfo(user, profileData) {
            const hour = new Date().getHours();
            let greetingText = "您好！";
            if (hour < 12) {
                greetingText = "早安！";
            } else if (hour < 18) {
                greetingText = "下午好！";
            } else {
                greetingText = "晚安！";
            }

            const settingsAvatar = document.getElementById('settings-avatar');
            const settingsDisplayName = document.getElementById('settings-display-name');
            const settingsUsername = document.getElementById('settings-username');

            if (user.isAnonymous) {
                greeting.textContent = `${greetingText}訪客！`;
                settingsAvatar.src = `https://placehold.co/100x100/e2e8f0/475569?text=?`;
                settingsDisplayName.textContent = '訪客';
                settingsUsername.textContent = '@guest';
            } else {
                const displayName = profileData ? profileData.displayName : user.email.split('@')[0];
                const username = profileData ? profileData.username : `@${user.email.split('@')[0]}`;
                
                greeting.textContent = `${greetingText}${displayName}！`;
                settingsAvatar.src = `https://placehold.co/100x100/fde68a/a16207?text=${displayName.charAt(0).toUpperCase()}`;
                settingsDisplayName.textContent = displayName;
                settingsUsername.textContent = username;
            }
        }


        onAuthStateChanged(auth, async (user) => {
            if (diariesUnsubscribe) diariesUnsubscribe();
            if (userProfileUnsubscribe) userProfileUnsubscribe();

            if (user) {
                console.log("User is signed in:", user.uid);
                
                const userDocRef = doc(db, "users", user.uid);
                if (!user.isAnonymous) {
                    const docSnap = await getDoc(userDocRef);
                    if (!docSnap.exists()) {
                        const name = user.email.split('@')[0];
                        await setDoc(userDocRef, {
                            displayName: name,
                            username: `@${name.toLowerCase()}`,
                            email: user.email,
                            bio: "熱愛用照片記錄家庭生活的點點滴滴。"
                        });
                    }
                }
                
                userProfileUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserProfile = docSnap.data();
                        updateUserInfo(user, currentUserProfile);
                    } else {
                        updateUserInfo(user, null);
                    }
                });

                const q = query(collection(db, "diaries"), where("authorId", "==", user.uid));
                
                diariesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    const diaries = [];
                    querySnapshot.forEach((doc) => {
                        diaries.push({ id: doc.id, ...doc.data() });
                    });
                    
                    diaries.sort((a, b) => {
                        const timeA = a.createdAt ? a.createdAt.toMillis() : 0;
                        const timeB = b.createdAt ? b.createdAt.toMillis() : 0;
                        return timeB - timeA;
                    });

                    renderDiaries(diaries);
                    
                    if (currentDiary && document.getElementById('detail-screen').classList.contains('is-active')) {
                        const updatedDiary = diaries.find(d => d.id === currentDiary.id);
                        if (updatedDiary) {
                            showDiaryDetail(updatedDiary);
                        }
                    }

                }, (error) => {
                    console.error("Error getting diaries: ", error);
                    diariesContainer.innerHTML = `
                        <div class="p-4 text-center">
                            <p class="font-bold text-red-600">讀取日記失敗</p>
                            <p class="text-sm text-gray-600 mt-2">權限不足，無法讀取資料庫。請檢查您的 Firestore 安全性規則。</p>
                        </div>
                    `;
                });

                if(navigationStack[0] === 'auth-screen') {
                    navigationStack = ['home-screen'];
                    navigateTo('home-screen');
                    navItems.forEach(nav => nav.classList.remove('active'));
                    document.querySelector('.bottom-nav-item[data-target="home-screen"]').classList.add('active');
                }

            } else {
                console.log("User is signed out.");
                renderDiaries([]);
                navigationStack = ['auth-screen'];
                navigateTo('auth-screen');
                currentUserProfile = null;
            }
        });

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const guestButton = document.getElementById('guest-button');
        const logoutButton = document.getElementById('logout-button');

        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<div class="spinner"></div>';
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText;
            }
        }
        
        loginButton.dataset.originalText = loginButton.innerHTML;
        registerButton.dataset.originalText = registerButton.innerHTML;
        
        loginButton.addEventListener('click', async () => {
            setButtonLoading(loginButton, true);
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
            } catch (error) {
                authError.textContent = "登入失敗：" + error.message;
            } finally {
                setButtonLoading(loginButton, false);
            }
        });

        registerButton.addEventListener('click', async () => {
            setButtonLoading(registerButton, true);
            authError.textContent = '';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
                const user = userCredential.user;
                
                // Create a user profile document
                const userDocRef = doc(db, "users", user.uid);
                const name = user.email.split('@')[0];
                await setDoc(userDocRef, {
                    displayName: name,
                    username: `@${name.toLowerCase()}`,
                    email: user.email,
                    bio: "熱愛用照片記錄家庭生活的點點滴滴。"
                });

            } catch (error) {
                authError.textContent = "註冊失敗：" + error.message;
            } finally {
                setButtonLoading(registerButton, false);
            }
        });
        
        guestButton.addEventListener('click', async () => {
             try {
                await signInAnonymously(auth);
            } catch (error) {
                authError.textContent = "訪客登入失敗：" + error.message;
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.dataset.target;
                navigationStack = [targetId];
                navigateTo(targetId);
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
            });
        });

        document.getElementById('fab-nav').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user && user.isAnonymous) {
                guestModal.classList.add('visible');
            } else if (user) {
                navigateTo('create-screen');
            } else {
                navigateTo('auth-screen');
            }
        });
        
        document.querySelectorAll('#explore-screen .masonry-item, #profile-screen .masonry-item').forEach(card => card.addEventListener('click', () => navigateTo('detail-screen')));
        document.querySelectorAll('#explore-screen .creator-card').forEach(card => card.addEventListener('click', () => navigateTo('profile-screen')));
        
        document.querySelectorAll('.go-back-button').forEach(button => button.addEventListener('click', goBack));
        
        document.getElementById('go-to-earnings').addEventListener('click', () => navigateTo('earnings-screen'));
        document.getElementById('go-to-groups').addEventListener('click', () => navigateTo('groups-screen'));
        document.querySelectorAll('#groups-screen .group-item').forEach(item => item.addEventListener('click', () => navigateTo('group-edit-screen')));
        document.getElementById('create-group-button').addEventListener('click', () => navigateTo('group-create-screen'));
        
        document.getElementById('go-to-profile-edit').addEventListener('click', () => {
            if (currentUserProfile) {
                document.getElementById('profile-edit-username').value = currentUserProfile.username || '';
                document.getElementById('profile-edit-display-name').value = currentUserProfile.displayName || '';
                document.getElementById('profile-edit-bio').value = currentUserProfile.bio || '';
                document.getElementById('profile-edit-email').value = currentUserProfile.email || '';
                document.getElementById('profile-edit-avatar').src = `https://placehold.co/100x100/fde68a/a16207?text=${currentUserProfile.displayName.charAt(0).toUpperCase()}`;
            }
            navigateTo('profile-edit-screen');
        });

        document.getElementById('save-profile-button').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            const newDisplayName = document.getElementById('profile-edit-display-name').value;
            const newBio = document.getElementById('profile-edit-bio').value;

            const userDocRef = doc(db, "users", user.uid);
            try {
                await updateDoc(userDocRef, {
                    displayName: newDisplayName,
                    bio: newBio
                });
                goBack();
            } catch (error) {
                console.error("Error updating profile: ", error);
                showToast("更新個人資料失敗！", "error");
            }
        });
        
        document.getElementById('go-to-writing-style').addEventListener('click', () => navigateTo('writing-style-screen'));

        // --- Create Diary Page ---
        const generateDiaryButton = document.getElementById('generate-diary-button');
        const photoUpload = document.getElementById('photo-upload');
        const photoGridContainer = document.getElementById('photo-grid-container');
        const photoCountSpan = document.getElementById('photo-count');

        function renderPhotoPreviews() {
            photoGridContainer.innerHTML = ''; 

            selectedFiles.forEach((file, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative aspect-square cursor-pointer';
                wrapper.dataset.index = index;

                const img = document.createElement('img');
                img.className = "rounded-lg w-full h-full object-cover";
                if (index === selectedCoverIndex) {
                    img.classList.add('cover-photo');
                }

                const removeBtn = document.createElement('button');
                removeBtn.className = 'absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold leading-none hover:bg-red-600 transition-colors z-10';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = "移除這張照片";
                
                const orderBadge = document.createElement('div');
                orderBadge.className = 'absolute top-2 left-2 w-6 h-6 bg-black/50 text-white rounded-full flex items-center justify-center text-xs font-bold z-10';
                orderBadge.textContent = index + 1;
                orderBadge.title = "照片順序";


                removeBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const indexToRemove = parseInt(wrapper.dataset.index, 10);
                    selectedFiles.splice(indexToRemove, 1);
                    if (selectedCoverIndex === indexToRemove) {
                        selectedCoverIndex = 0;
                    } else if (selectedCoverIndex > indexToRemove) {
                        selectedCoverIndex--;
                    }
                    renderPhotoPreviews();
                });

                wrapper.addEventListener('click', () => {
                    selectedCoverIndex = parseInt(wrapper.dataset.index, 10);
                    renderPhotoPreviews();
                });

                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                wrapper.appendChild(orderBadge);
                photoGridContainer.appendChild(wrapper);

                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            });

            const addPhotoLabel = document.createElement('label');
            addPhotoLabel.htmlFor = 'photo-upload';
            addPhotoLabel.className = "aspect-square bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors";
            addPhotoLabel.innerHTML = `
                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                <span class="mt-2 text-sm text-gray-500">新增照片</span>
            `;
            photoGridContainer.appendChild(addPhotoLabel);

            photoCountSpan.textContent = `已選取的照片 (${selectedFiles.length})`;
            if (generateDiaryButton) {
                generateDiaryButton.disabled = selectedFiles.length === 0;
            }
        }

        if(photoUpload) {
            photoUpload.addEventListener('change', (event) => {
                const newFiles = Array.from(event.target.files);
                
                newFiles.forEach(newFile => {
                    // Check for duplicates based on name, size, and last modified date
                    const isDuplicate = selectedFiles.some(existingFile => 
                        existingFile.name === newFile.name &&
                        existingFile.size === newFile.size &&
                        existingFile.lastModified === newFile.lastModified
                    );

                    if (!isDuplicate) {
                        selectedFiles.push(newFile);
                    }
                });

                renderPhotoPreviews();
                event.target.value = ''; // Clear the input to allow selecting the same file again after removing it
            });
        }
        
        function resetCreateForm() {
            photoUpload.value = '';
            selectedFiles = [];
            selectedCoverIndex = 0;
            renderPhotoPreviews();
        }

        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        }
        
        generateDiaryButton.dataset.originalText = generateDiaryButton.innerHTML;
        generateDiaryButton.addEventListener('click', async (e) => {
            e.preventDefault();
            setButtonLoading(generateDiaryButton, true);
            createError.textContent = '';
            
            const user = auth.currentUser;
            if (!user) {
                createError.textContent = "錯誤：您尚未登入。";
                setButtonLoading(generateDiaryButton, false);
                return;
            }

            const privacy = document.getElementById('privacy-select').value;
            const styleElement = document.querySelector('input[name="writing-style"]:checked');
            const styleValue = styleElement ? styleElement.value : 'warm';
            
            const styleMapping = {
                warm: '溫馨感性風',
                fun: '活潑有趣風',
                simple: '簡潔紀錄風'
            };
            const styleText = styleMapping[styleValue] || '溫馨感性風';
            
            try {
                const uploadedPhotoURLs = [];
                if (selectedFiles.length > 0) {
                    const uploadPromises = selectedFiles.map(async (file) => {
                        const options = {
                            maxSizeMB: 1,
                            maxWidthOrHeight: 1920,
                            useWebWorker: true
                        }
                        const compressedFile = await imageCompression(file, options);
                        const filePath = `diaries/${user.uid}/${Date.now()}-${compressedFile.name}`;
                        const storageRef = ref(storage, filePath);
                        const snapshot = await uploadBytes(storageRef, compressedFile);
                        return await getDownloadURL(snapshot.ref);
                    });
                    uploadedPhotoURLs.push(...await Promise.all(uploadPromises));
                }

                const textPrompt = `請根據我提供的 ${selectedFiles.length} 張照片，用${styleText}風格，生成一個JSON物件。物件需包含：
1. "title": 符合風格的故事標題，長度請勿超過14個字。
2. "overall_story": 將所有照片串連起來的總結性故事，長度請勿超過100個字。
3. "events": 一個陣列，陣列中每個物件代表一張照片，包含 "time" (照片的時間，如果未知請推測，格式為 '下午 03:15')、 "location" (照片的地點，如果未知請推測具體名稱，例如 '高雄市，駁二藝術特區')、 "description" (照片的事件描述，100字內)。
4. "cover_photo_index": 一個數字，代表你認為最適合當封面的照片索引（從0開始）。`;
                
                const imageParts = await Promise.all(selectedFiles.map(fileToGenerativePart));
                
                const payload = {
                    contents: [{ parts: [{ text: textPrompt }, ...imageParts] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "overall_story": { "type": "STRING" },
                                "events": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "time": { "type": "STRING" },
                                            "location": { "type": "STRING" },
                                            "description": { "type": "STRING" }
                                        },
                                        "required": ["time", "location", "description"]
                                    }
                                },
                                "cover_photo_index": { "type": "NUMBER" }
                            },
                            required: ["title", "overall_story", "events", "cover_photo_index"]
                        }
                    }
                };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                     throw new Error("Invalid API response structure.");
                }
                const generatedData = JSON.parse(result.candidates[0].content.parts[0].text);
                
                const finalCoverIndex = selectedCoverIndex || generatedData.cover_photo_index || 0;

                const diaryData = {
                    title: generatedData.title,
                    overall_story: generatedData.overall_story,
                    events: JSON.stringify(generatedData.events),
                    privacy: privacy,
                    authorId: user.uid,
                    createdAt: serverTimestamp(),
                    photoURLs: uploadedPhotoURLs,
                    likes: [],
                    style: styleValue,
                    coverPhotoIndex: finalCoverIndex
                };
                
                const docRef = await addDoc(collection(db, "diaries"), diaryData);
                console.log("日記已儲存，ID: ", docRef.id);
                
                resetCreateForm();
                navigationStack = ['home-screen']; 
                navigateTo('home-screen');

            } catch (error) {
                console.error("儲存日記時發生錯誤: ", error);
                createError.textContent = "日記生成或儲存失敗，請稍後再試。";
            } finally {
                setButtonLoading(generateDiaryButton, false);
            }
        });
        
        const editButton = document.getElementById('edit-button');
        if(editButton) {
            editButton.addEventListener('click', () => {
                if (!currentDiary) return;
                
                let eventsArray = currentDiary.events;
                if (typeof eventsArray === 'string') {
                    try {
                        eventsArray = JSON.parse(eventsArray);
                    } catch (e) {
                        eventsArray = [];
                    }
                }

                if (!Array.isArray(eventsArray)) {
                    showToast("此日記格式不支援編輯。", "error");
                    return;
                }

                document.getElementById('edit-title').value = currentDiary.title || '';
                document.getElementById('edit-overall-story').value = currentDiary.overall_story || '';
                
                const eventsContainer = document.getElementById('edit-events-container');
                eventsContainer.innerHTML = ''; // Clear previous
                
                eventsArray.forEach((event, index) => {
                    const eventEditorHTML = `
                        <div>
                            <label class="text-base font-semibold text-gray-600">事件 ${index + 1} 描述</label>
                            <textarea data-event-index="${index}" class="edit-event-description w-full mt-1 p-2 border border-gray-300 rounded-lg h-20">${event.description || ''}</textarea>
                        </div>
                    `;
                    eventsContainer.insertAdjacentHTML('beforeend', eventEditorHTML);
                });

                navigateTo('edit-screen');
            });
        }

        const saveButton = document.getElementById('save-button');
        if(saveButton) {
            saveButton.addEventListener('click', async () => {
                if (!currentDiary || !currentDiary.id) {
                    showToast("找不到要儲存的日記！", "error");
                    return;
                }

                const newTitle = document.getElementById('edit-title').value;
                const newOverallStory = document.getElementById('edit-overall-story').value;
                const descriptionElements = document.querySelectorAll('.edit-event-description');
                
                let currentEvents = currentDiary.events;
                 if (typeof currentEvents === 'string') {
                     try {
                        currentEvents = JSON.parse(currentEvents);
                     } catch(e) {
                         currentEvents = [];
                     }
                }

                const newEvents = Array.from(descriptionElements).map((textarea, index) => {
                    return {
                        ...currentEvents[index], // Preserve time and location
                        description: textarea.value
                    };
                });

                const updatedData = {
                    title: newTitle,
                    overall_story: newOverallStory,
                    events: JSON.stringify(newEvents)
                };

                try {
                    const diaryRef = doc(db, "diaries", currentDiary.id);
                    await updateDoc(diaryRef, updatedData);
                    
                    currentDiary = { ...currentDiary, ...updatedData };
                    goBack(); 
                    showDiaryDetail(currentDiary); 

                } catch (error) {
                    console.error("更新日記失敗:", error);
                    showToast("儲存失敗，請稍後再試。", "error");
                }
            });
        }

        const shareButton = document.getElementById('share-button');
        const modalContainer = document.getElementById('share-modal-container');
        if (shareButton) {
            shareButton.addEventListener('click', () => modalContainer.classList.add('visible'));
            document.getElementById('close-modal-button').addEventListener('click', () => modalContainer.classList.remove('visible'));
            document.getElementById('done-button').addEventListener('click', () => modalContainer.classList.remove('visible'));
            document.getElementById('share-modal-backdrop').addEventListener('click', () => modalContainer.classList.remove('visible'));
            
            document.querySelectorAll('.share-group-button').forEach(button => {
                button.addEventListener('click', () => {
                    const groupName = button.querySelector('span:last-child').textContent;
                    showToast(`已分享給 ${groupName}！`);
                    modalContainer.classList.remove('visible');
                });
            });

            const copyButton = document.getElementById('copy-link-button');
            copyButton.addEventListener('click', () => {
                const linkInput = copyButton.previousElementSibling;
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showToast('連結已複製！');
                });
            });
        }
        
        const addMemberButton = document.getElementById('add-member-button');
        const addMemberModalContainer = document.getElementById('add-member-modal-container');
        const inviteLinkDetails = document.getElementById('invite-link-details');

        if (addMemberButton) {
            addMemberButton.addEventListener('click', () => {
                inviteLinkDetails.classList.add('hidden');
                addMemberModalContainer.classList.add('visible');
            });
        }

        const closeAddMemberModalButton = document.getElementById('close-add-member-modal-button');
        const addMemberModalBackdrop = document.getElementById('add-member-modal-backdrop');

        function closeAddMemberModal() {
            if(addMemberModalContainer) addMemberModalContainer.classList.remove('visible');
        }

        if(closeAddMemberModalButton) closeAddMemberModalButton.addEventListener('click', closeAddMemberModal);
        if(addMemberModalBackdrop) addMemberModalBackdrop.addEventListener('click', closeAddMemberModal);

        document.querySelectorAll('.invite-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.target.textContent = '已邀請';
                e.target.disabled = true;
                e.target.classList.remove('bg-blue-500');
                e.target.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
                showToast('已送出邀請！');
            });
        });
        
        const generateInviteLinkButton = document.getElementById('generate-invite-link');
        if(generateInviteLinkButton) {
            generateInviteLinkButton.addEventListener('click', () => {
                inviteLinkDetails.classList.toggle('hidden');
            });
        }
        
        const copyInviteLinkButton = document.getElementById('copy-invite-link-button');
        if(copyInviteLinkButton) {
             copyInviteLinkButton.addEventListener('click', () => {
                const linkInput = copyInviteLinkButton.previousElementSibling;
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showToast('邀請連結已複製！');
                });
            });
        }

        const emojiPickerButton = document.getElementById('emoji-picker-button');
        if (emojiPickerButton) {
            const emojis = ['🍽️', '🏕️', '🎂', '🏖️', '✈️', '🎉', '🏠'];
            let currentIndex = 0;
            emojiPickerButton.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % emojis.length;
                emojiPickerButton.textContent = emojis[currentIndex];
            });
        }

        const customPromptTextarea = document.getElementById('custom-prompt-style');
        if(customPromptTextarea) {
            document.querySelectorAll('input[name="writing-style-option"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'custom') {
                        customPromptTextarea.disabled = false;
                        customPromptTextarea.classList.remove('bg-gray-50');
                    } else {
                        customPromptTextarea.disabled = true;
                        customPromptTextarea.classList.add('bg-gray-50');
                    }
                });
            });
        }

        const exploreTabs = document.querySelectorAll('.explore-tab');
        const tabContents = document.querySelectorAll('#explore-screen .tab-content');

        exploreTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                exploreTabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.add('hidden'));

                tab.classList.add('active');
                const contentId = tab.dataset.tab + '-content';
                document.getElementById(contentId).classList.remove('hidden');
            });
        });

        document.getElementById('close-guest-modal-button').addEventListener('click', () => {
            guestModal.classList.remove('visible');
        });
        document.getElementById('go-to-auth-button').addEventListener('click', async () => {
            guestModal.classList.remove('visible');
            await signOut(auth);
            navigateTo('auth-screen');
        });

        document.querySelectorAll('.adventure-card').forEach(card => {
            card.addEventListener('click', () => {
                navigateTo('adventure-detail-screen');
            });
        });

        const toastElement = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        let toastTimeout;

        function showToast(message, type = 'success') {
            clearTimeout(toastTimeout);

            toastMessage.textContent = message;

            toastElement.classList.remove('bg-green-500', 'bg-red-500', 'show');

            if (type === 'success') {
                toastElement.classList.add('bg-green-500');
            } else if (type === 'error') {
                toastElement.classList.add('bg-red-500');
            }

            toastElement.classList.add('show');

            toastTimeout = setTimeout(() => {
                toastElement.classList.remove('show');
            }, 3000);
        }
        
    </script>
</body>
</html>
